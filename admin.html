<!DOCTYPE html>
<html lang="ja">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Creator Dashboard | Sien-Official</title>
    <link rel="icon" type="image/png" href="./assets/favicon.png">

    <!-- Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link
        href="https://fonts.googleapis.com/css2?family=Jost:wght@300;400;500;600&family=Noto+Sans+JP:wght@300;400;500;700&display=swap"
        rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

    <!-- Global Style -->
    <link rel="stylesheet" href="style.css">

    <style>
        /* --- ADMIN DASHBOARD THEME --- */
        body {
            background-color: var(--bg-gray);
            font-family: var(--font-body);
            color: var(--text-main);
        }

        /* Utils */
        .hidden {
            display: none !important;
        }

        .flex {
            display: flex;
        }

        .items-center {
            align-items: center;
        }

        .justify-between {
            justify-content: space-between;
        }

        .gap-2 {
            gap: 0.5rem;
        }

        .gap-4 {
            gap: 1rem;
        }

        .mt-4 {
            margin-top: 1rem;
        }

        .mb-4 {
            margin-bottom: 1rem;
        }

        .text-sm {
            font-size: 0.875rem;
        }

        .text-gray {
            color: var(--text-muted);
        }

        .font-bold {
            font-weight: 700;
        }

        .w-full {
            width: 100%;
        }

        /* Auth Screen */
        #auth-screen {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100vh;
            background: rgba(255, 255, 255, 0.8);
            backdrop-filter: blur(10px);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1000;
        }

        .auth-card {
            background: white;
            padding: 3rem;
            border-radius: 20px;
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.1);
            width: 100%;
            max-width: 400px;
            text-align: center;
        }

        /* Nav & Headers */
        .admin-header {
            background: white;
            border-bottom: 1px solid var(--border-color);
            padding: 0 24px;
            height: 64px;
            display: flex;
            align-items: center;
            justify-content: space-between;
        }

        .brand {
            font-family: var(--font-heading);
            font-weight: 700;
            font-size: 1.25rem;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .brand span {
            color: var(--accent-blue);
        }

        .user-menu {
            display: flex;
            align-items: center;
            gap: 16px;
        }

        .avatar img {
            width: 32px;
            height: 32px;
            border-radius: 50%;
            object-fit: cover;
        }

        /* NAVIGATION */
        .nav-bar {
            background: white;
            border-bottom: 1px solid var(--border-color);
            padding: 0 24px;
            display: flex;
            gap: 24px;
        }

        .nav-item {
            padding: 16px 0;
            font-size: 0.9rem;
            font-weight: 500;
            color: var(--text-muted);
            cursor: pointer;
            border-bottom: 2px solid transparent;
            transition: 0.2s;
        }

        .nav-item:hover {
            color: var(--accent-blue);
        }

        .nav-item.active {
            color: var(--accent-blue);
            border-bottom-color: var(--accent-blue);
        }

        /* Main Layout */
        .main-content {
            padding: 32px 24px;
            max-width: 1200px;
            margin: 0 auto;
        }

        .page-title {
            font-size: 1.5rem;
            font-weight: 700;
            margin-bottom: 2rem;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        /* FILTER BAR */
        .filter-bar {
            display: flex;
            gap: 5px;
            margin-bottom: 20px;
            flex-wrap: wrap;
            background: white;
            padding: 10px 20px;
            border-radius: 8px;
            border: 1px solid #e5e7eb;
        }

        .filter-chip {
            padding: 6px 14px;
            border-radius: 20px;
            font-size: 0.85rem;
            cursor: pointer;
            color: #6b7280;
            font-weight: 500;
        }

        .filter-chip:hover {
            background: #f3f4f6;
        }

        .filter-chip.active {
            background: #eff6ff;
            color: var(--accent-blue);
            font-weight: 600;
        }

        .search-input {
            margin-left: auto;
            border: 1px solid #e5e7eb;
            padding: 6px 12px;
            border-radius: 6px;
            font-size: 0.9rem;
            width: 250px;
        }

        /* DATA TABLE */
        .data-card {
            background: white;
            border-radius: 12px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.02);
            overflow: hidden;
            border: 1px solid #e5e7eb;
        }

        .data-table {
            width: 100%;
            border-collapse: collapse;
        }

        .data-table th {
            background: #f9fafb;
            padding: 16px 24px;
            text-align: left;
            font-weight: 600;
            font-size: 0.8rem;
            text-transform: uppercase;
            color: #6b7280;
            letter-spacing: 0.05em;
        }

        .data-table td {
            padding: 16px 24px;
            border-top: 1px solid #f3f4f6;
            vertical-align: middle;
            color: #374151;
        }

        .data-table tr:hover {
            background: #f9fafb;
            transition: background 0.1s;
        }

        .user-cell {
            display: flex;
            flex-direction: column;
        }

        .user-name {
            font-weight: 600;
            font-size: 0.95rem;
        }

        .user-sub {
            font-size: 0.8rem;
            color: #9ca3af;
        }

        /* STATUS BADGES */
        .status-badge {
            padding: 4px 10px;
            border-radius: 6px;
            font-size: 0.75rem;
            font-weight: 600;
            display: inline-block;
            white-space: nowrap;
        }

        .bg-gray-100 {
            background: #f3f4f6;
            color: #4b5563;
        }

        .bg-orange-100 {
            background: #fff7ed;
            color: #c2410c;
        }

        .bg-green-100 {
            background: #ecfdf5;
            color: #047857;
        }

        .bg-blue-100 {
            background: #eff6ff;
            color: #1e40af;
        }

        .bg-red-100 {
            background: #fef2f2;
            color: #b91c1c;
        }

        /* PORTFOLIO GRID */
        .pf-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
            gap: 24px;
        }

        .pf-card {
            background: white;
            border-radius: 12px;
            border: 1px solid #e5e7eb;
            overflow: hidden;
            transition: transform 0.2s;
        }

        .pf-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 20px rgba(0, 0, 0, 0.05);
        }

        .pf-thumb {
            aspect-ratio: 16/9;
            background: #111;
            position: relative;
        }

        .pf-thumb iframe {
            width: 100%;
            height: 100%;
            opacity: 0.8;
            pointer-events: none;
        }

        .pf-body {
            padding: 16px;
        }

        .form-label {
            display: block;
            font-size: 0.75rem;
            font-weight: 600;
            color: #6b7280;
            margin-bottom: 4px;
        }

        .form-input {
            width: 100%;
            padding: 8px 10px;
            border: 1px solid #e5e7eb;
            border-radius: 6px;
            font-size: 0.9rem;
            margin-bottom: 12px;
            transition: border 0.2s;
        }

        .form-input:focus {
            outline: none;
            border-color: var(--accent-blue);
            box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
        }

        .action-bar {
            border-top: 1px solid #f3f4f6;
            padding: 10px 16px;
            display: flex;
            justify-content: flex-end;
            background: #f9fafb;
        }

        /* BUTTONS */
        .btn {
            padding: 8px 16px;
            border-radius: 6px;
            font-weight: 500;
            font-size: 0.9rem;
            cursor: pointer;
            border: none;
            display: inline-flex;
            align-items: center;
            gap: 6px;
            transition: 0.2s;
        }

        .btn-primary {
            background: var(--accent-blue);
            color: white;
        }

        .btn-primary:hover {
            background: var(--accent-dark);
        }

        .btn-danger {
            background: white;
            color: #ef4444;
            border: 1px solid #ef4444;
        }

        .btn-danger:hover {
            background: #fef2f2;
        }

        .btn-ghost {
            background: transparent;
            color: #6b7280;
        }

        .btn-ghost:hover {
            background: #f3f4f6;
            color: #111;
        }

        .btn-sm {
            padding: 5px 10px;
            font-size: 0.8rem;
        }

        .loading-spinner {
            position: fixed;
            bottom: 20px;
            right: 20px;
            background: #111;
            color: white;
            padding: 10px 20px;
            border-radius: 50px;
            font-size: 0.9rem;
            z-index: 9999;
            display: none;
            align-items: center;
            gap: 10px;
            box-shadow: 0 5px 20px rgba(0, 0, 0, 0.2);
        }

        /* Price Form */
        .price-container {
            max-width: 800px;
            margin: 0 auto;
            background: white;
            padding: 40px;
            border-radius: 12px;
            border: 1px solid #e5e7eb;
        }

        .price-row {
            display: grid;
            grid-template-columns: 2fr 1fr;
            gap: 20px;
            align-items: center;
            padding: 16px 0;
            border-bottom: 1px solid #f1f5f9;
        }

        .price-row:last-child {
            border-bottom: none;
        }

        /* MODAL */
        .modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            z-index: 2000;
            display: flex;
            justify-content: center;
            align-items: center;
            opacity: 0;
            pointer-events: none;
            transition: 0.2s;
        }

        .modal.open {
            opacity: 1;
            pointer-events: auto;
        }

        .modal-content {
            background: white;
            width: 90%;
            max-width: 700px;
            max-height: 90vh;
            border-radius: 12px;
            overflow-y: auto;
            padding: 30px;
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.2);
            position: relative;
        }

        .close-modal {
            position: absolute;
            top: 20px;
            right: 20px;
            background: #f3f4f6;
            border: none;
            width: 32px;
            height: 32px;
            border-radius: 50%;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .close-modal:hover {
            background: #e5e7eb;
        }

        .detail-row {
            display: grid;
            grid-template-columns: 140px 1fr;
            gap: 20px;
            padding: 12px 0;
            border-bottom: 1px solid #f3f4f6;
            font-size: 0.9rem;
        }

        .detail-label {
            font-weight: 600;
            color: var(--text-muted);
        }

        .detail-value a {
            color: var(--accent-blue);
            text-decoration: underline;
        }
    </style>
</head>

<body>

    <!-- Loading Indicator -->
    <div id="loading" class="loading-spinner"><i class="fa-solid fa-spinner fa-spin"></i> Saving...</div>

    <!-- Auth Screen -->
    <div id="auth-screen">
        <div class="auth-card">
            <h2 class="brand mb-4"><span>></span>Sien-Official</h2>
            <p class="text-gray mb-4">ÁÆ°ÁêÜ„Éë„Çπ„ÉØ„Éº„Éâ„ÇíÂÖ•Âäõ„Åó„Å¶„Åè„Å†„Åï„ÅÑ</p>
            <input type="password" id="auth-pass" class="form-input" style="text-align: center;" placeholder="Password">
            <button class="btn btn-primary w-full mt-4" onclick="login()">„ÉÄ„ÉÉ„Ç∑„É•„Éú„Éº„Éâ„Å´„É≠„Ç∞„Ç§„É≥</button>
            <p id="auth-msg" class="text-sm mt-4" style="color:#ef4444;"></p>
        </div>
    </div>

    <!-- Header -->
    <header class="admin-header">
        <div class="brand"><span>></span>Studio</div>
        <div class="user-menu">
            <span class="text-sm font-bold">Sien</span>
            <div class="avatar"><img src="./assets/profile.jpg" alt=""></div>
            <button class="btn btn-ghost btn-sm" onclick="logout()"><i
                    class="fa-solid fa-right-from-bracket"></i></button>
        </div>
    </header>

    <!-- Nav -->
    <nav class="nav-bar">
        <div class="nav-item active" onclick="switchTab('orders')">‰æùÈ†ºÁÆ°ÁêÜ</div>
        <div class="nav-item" onclick="switchTab('portfolio')">„Éù„Éº„Éà„Éï„Ç©„É™„Ç™</div>
        <div class="nav-item" onclick="switchTab('prices')">„Éó„É©„É≥„ÉªÊñôÈáëË®≠ÂÆö</div>
        <div class="nav-item" onclick="switchTab('voices')">„ÅäÂÆ¢Êßò„ÅÆÂ£∞</div>
    </nav>

    <!-- Main Content -->
    <main class="main-content">

        <!-- Tab: Orders -->
        <div id="tab-orders" class="tab-pane">
            <div class="page-title">
                ‰æùÈ†ºÁÆ°ÁêÜ <span class="text-sm text-gray" style="font-weight:400;">(Rank: Pro)</span>
            </div>

            <div class="filter-bar" style="display:flex; justify-content:space-between; align-items:center;">
                <div class="flex gap-2">
                    <span style="font-weight:bold; margin-right:10px;">Filter:</span>
                    <div class="filter-chip active" onclick="filterOrders('all', this)">ÂÖ®„Å¶</div>
                    <div class="filter-chip" onclick="filterOrders('Êú™ÁùÄÊâã', this)">Êú™ÁùÄÊâã</div>
                    <div class="filter-chip" onclick="filterOrders('ÊîØÊâï„ÅÑÂæÖ„Å°', this)">ÊîØÊâï„ÅÑÂæÖ„Å°</div>
                </div>
                <div class="flex gap-2">
                    <input type="text" id="order-search" class="search-input" placeholder="ÂêçÂâç/Êõ≤Âêç„ÅßÊ§úÁ¥¢"
                        onkeyup="renderOrders(this.value)" style="width:200px;">
                    <select id="order-sort" class="form-input" style="width:auto; margin:0;" onchange="renderOrders()">
                        <option value="newest">Êñ∞ÁùÄÈ†Ü</option>
                        <option value="deadline">Á¥çÊúü„ÅåËøë„ÅÑÈ†Ü</option>
                        <option value="status">„Çπ„ÉÜ„Éº„Çø„ÇπÈ†Ü</option>
                    </select>
                    <button class="btn btn-primary btn-sm" onclick="fetchData()"><i
                            class="fa-solid fa-rotate-right"></i></button>
                </div>
            </div>

            <div class="data-card">
                <table class="data-table">
                    <thead>
                        <tr>
                            <th>„Åî‰æùÈ†ºÊó•</th>
                            <th>Êõ≤Âêç</th>
                            <th>„Åî‰æùÈ†ºËÄÖÂêç</th>
                            <th>„Éó„É©„É≥</th>
                            <th>ÊîØÊâï„ÅÑ</th>
                            <th>Á¥çÊúü</th>
                            <th>„Çπ„ÉÜ„Éº„Çø„Çπ</th>
                        </tr>
                    </thead>
                    <tbody id="order-list">
                        <!-- JS Insert -->
                    </tbody>
                </table>
            </div>
        </div>

        <!-- Tab: Portfolio -->
        <div id="tab-portfolio" class="tab-pane hidden">
            <div class="flex justify-between items-center mb-4">
                <div class="page-title" style="margin:0;">„Éù„Éº„Éà„Éï„Ç©„É™„Ç™</div>
                <button class="btn btn-primary" onclick="savePortfolio()"><i class="fa-solid fa-cloud-arrow-up"></i>
                    Â§âÊõ¥„Çí‰øùÂ≠ò</button>
            </div>

            <div class="mb-4">
                <div class="filter-bar" style="display:inline-flex;">
                    <div class="filter-chip active" onclick="switchPfCat('works', this)">Âà∂‰ΩúÂÆüÁ∏æ (Works)</div>
                    <div class="filter-chip" onclick="switchPfCat('mix', this)">Mix Samples</div>
                    <div class="filter-chip" onclick="switchPfCat('orig', this)">Original Songs</div>
                </div>
            </div>

            <!-- Pf Works -->
            <div id="pf-works" class="pf-grid"></div>
            <div id="pf-mix" class="pf-grid hidden"></div>
            <div id="pf-orig" class="pf-grid hidden"></div>

            <div class="mt-4 text-center">
                <button class="btn btn-ghost" style="border:1px dashed #ccc; width:100%; padding:20px;"
                    onclick="addPfItem()">+ Êñ∞Ë¶è„Ç¢„Ç§„ÉÜ„É†„ÇíËøΩÂä†</button>
            </div>
        </div>

        <!-- Tab: Prices -->
        <div id="tab-prices" class="tab-pane hidden">
            <div class="page-title">„Éó„É©„É≥„ÉªÊñôÈáëË®≠ÂÆö</div>
            <div class="price-container">
                <h3 class="font-bold mb-4"
                    style="border-bottom:2px solid var(--accent-blue); padding-bottom:10px; display:inline-block;">Âü∫Êú¨„Éó„É©„É≥
                </h3>
                <div id="price-form">
                    <!-- JS Insert -->
                </div>
                <div class="mt-4 text-right">
                    <button class="btn btn-primary" onclick="savePrices()">Ë®≠ÂÆö„Çí‰øùÂ≠ò</button>
                </div>
            </div>
        </div>

        <!-- Tab: Order Detail -->
        <div id="tab-order-detail" class="tab-pane hidden">
            <div class="mb-4">
                <button class="btn btn-ghost btn-sm" onclick="backToOrders()"><i class="fa-solid fa-arrow-left"></i>
                    ‰æùÈ†º‰∏ÄË¶ß„Å´Êàª„Çã</button>
            </div>
            <div class="page-title">
                ‰æùÈ†ºË©≥Á¥∞
            </div>
            <div class="price-container" style="max-width:100%;">
                <div id="detail-content">
                    <!-- JS Render -->
                </div>
                <!-- Tab: Voices -->
                <div id="tab-voices" class="tab-pane hidden">
                    <div class="page-title">„ÅäÂÆ¢Êßò„ÅÆÂ£∞ ÁÆ°ÁêÜ</div>
                    <div class="mb-4 text-right">
                        <button class="btn btn-primary" onclick="addVoice()">+ ÊÑüÊÉ≥„ÇíËøΩÂä†</button>
                        <button class="btn btn-primary" onclick="saveVoices()">‰øùÂ≠ò</button>
                    </div>
                    <div id="voice-list" class="pf-grid" style="grid-template-columns: 1fr;"></div>
                </div>

    </main>




    <!-- JAVASCRIPT LOGIC -->
    <script>
        // --- CORE STATE ---
        let TOKEN = localStorage.getItem('admin_token') || '';
        let DATA = { orders: [], works: [], mix: [], orig: [], prices: { mix: [], orig: [] }, voices: [] };
        let activePfCat = 'works';

        // --- AUTH ---
        function checkAuth() {
            if (TOKEN) {
                document.getElementById('auth-screen').style.display = 'none';
                fetchData();
            }
        }
        async function login() {
            const pass = document.getElementById('auth-pass').value;
            if (!pass) return;
            try {
                const res = await fetch('/api/admin', { headers: { 'x-admin-password': pass } });
                if (res.ok) {
                    TOKEN = pass;
                    localStorage.setItem('admin_token', pass);
                    checkAuth();
                } else {
                    document.getElementById('auth-msg').innerText = "„Éë„Çπ„ÉØ„Éº„Éâ„ÅåÊ≠£„Åó„Åè„ÅÇ„Çä„Åæ„Åõ„Çì";
                }
            } catch (e) { alert("Network Error"); }
        }
        function logout() { localStorage.removeItem('admin_token'); location.reload(); }

        // --- FETCH ---
        async function fetchData() {
            document.getElementById('loading').style.display = 'flex';
            try {
                const res = await fetch('/api/admin', { headers: { 'x-admin-password': TOKEN } });
                if (res.status === 401) return logout();
                DATA = await res.json();

                renderOrders();
                renderPortfolio();
                renderPrices();

                // Update Counts
                document.getElementById('count-all').innerText = DATA.orders.length;
                document.getElementById('count-new').innerText = DATA.orders.filter(o => o.status === 'Êú™ÁùÄÊâã').length;

            } catch (e) { console.error(e); }
            finally { document.getElementById('loading').style.display = 'none'; }
        }

        // --- TABS ---
        function switchTab(id) {
            document.querySelectorAll('.tab-pane').forEach(el => el.classList.add('hidden'));
            document.querySelectorAll('.nav-item').forEach(el => el.classList.remove('active'));
            document.getElementById(`tab-${id}`).classList.remove('hidden');
            // Assuming order matches: 0=orders, 1=pf, 2=prices, 3=voices
            const idx = id === 'orders' ? 0 : id === 'portfolio' ? 1 : id === 'prices' ? 2 : 3;
            if (document.querySelectorAll('.nav-item')[idx]) {
                document.querySelectorAll('.nav-item')[idx].classList.add('active');
            }
        }

        // --- ORDERS UI ---
        let currentStatusFilter = 'all';
        function filterOrders(status, btn) {
            currentStatusFilter = status;
            if (btn) {
                document.querySelectorAll('#tab-orders .filter-chip').forEach(c => c.classList.remove('active'));
                btn.classList.add('active');
            }
            renderOrders();
        }

        function renderOrders(query = '') {
            if (!query) query = document.getElementById('order-search') ? document.getElementById('order-search').value : '';
            const tbody = document.getElementById('order-list');
            tbody.innerHTML = '';

            let list = [...DATA.orders];

            // 1. Filter
            list = list.filter(o => {
                const matchesStatus = currentStatusFilter === 'all' || o.status === currentStatusFilter;
                const matchesSearch = !query ||
                    (o['Êõ≤Âêç'] && o['Êõ≤Âêç'].toLowerCase().includes(query.toLowerCase())) ||
                    (o['„Åî‰æùÈ†ºËÄÖÂêç'] && o['„Åî‰æùÈ†ºËÄÖÂêç'].toLowerCase().includes(query.toLowerCase()));
                return matchesStatus && matchesSearch;
            });

            // 2. Sort
            const sortMode = document.getElementById('order-sort') ? document.getElementById('order-sort').value : 'newest';
            if (sortMode === 'deadline') {
                // Assuming deadline is text YYYY-MM-DD or similiar, simple sort might work or need parse
                list.sort((a, b) => (a['Á¥çÊúü'] || '99999') > (b['Á¥çÊúü'] || '99999') ? 1 : -1);
            } else if (sortMode === 'status') {
                list.sort((a, b) => a.status.localeCompare(b.status));
            } else {
                // Newest (Date compare?) Assuming default pushed order is oldest->newest or newest->oldest?
                // KV lrange returns index 0 to N. Usually push pushes to tail. So 0 is oldest.
                // Reversing gives newest first.
                list.reverse();
            }

            list.forEach(o => {
                const date = new Date(o.date).toLocaleDateString('ja-JP');
                const badgeClass = getStatusClass(o.status);

                const tr = document.createElement('tr');
                tr.innerHTML = `
                    <td><div class="text-sm font-bold text-gray">${date}</div></td>
                    <td><div class="font-bold text-primary" style="color:var(--accent-blue); cursor:pointer;" onclick="showOrderDetail('${o.id}')">${o['Êõ≤Âêç']}</div></td>
                    <td><div class="user-cell"><span class="user-name">${o['„Åî‰æùÈ†ºËÄÖÂêç']}</span><span class="user-sub">${o['TwitterID(‰ªªÊÑè)']}</span></div></td>
                    <td><span class="text-sm">${PLAN_MAP[o['„Éó„É©„É≥']] || o['„Éó„É©„É≥']}</span></td>
                    <td>
                        ${o.paymentLink ? `<a href="${o.paymentLink}" target="_blank" class="btn btn-ghost btn-sm" style="color:#0ea5e9;">¬• ÊîØÊâï„ÅÑ„É™„É≥„ÇØ</a>` : `<button class="btn btn-ghost btn-sm text-gray" onclick="setPayLink('${o.id}')">Êú™Ë®≠ÂÆö</button>`}
                    </td>
                    <td><span class="text-sm text-gray">Êú™Ë®≠ÂÆö</span></td>
                    <td>
                        <select class="status-badge ${badgeClass}" style="border:none; cursor:pointer;" onchange="updateStatus('${o.id}', this.value)">
                            ${['Êú™ÁùÄÊâã', 'ÊîØÊâï„ÅÑÂæÖ„Å°', 'ÂÖ®„Å¶ÂÖ•ÈáëÊ∏à„Åø', 'Á¥çÂìÅÊ∏à„Åø', 'ÂèñÂºïÁµÇ‰∫Ü', '„Ç≠„É£„É≥„Çª„É´'].map(s => `<option value="${s}" ${o.status === s ? 'selected' : ''}>${s}</option>`).join('')}
                        </select>
                    </td>
                `;
                tbody.appendChild(tr);
            });
        }
        function getStatusClass(s) {
            if (s === 'Êú™ÁùÄÊâã') return 'bg-gray-100';
            if (s === 'ÊîØÊâï„ÅÑÂæÖ„Å°') return 'bg-orange-100';
            if (s === 'ÂÖ®„Å¶ÂÖ•ÈáëÊ∏à„Åø') return 'bg-green-100';
            if (s === 'ÂèñÂºïÁµÇ‰∫Ü') return 'bg-gray-100';
            if (s === '„Ç≠„É£„É≥„Çª„É´') return 'bg-red-100';
            return 'bg-blue-100';
        }
        async function updateStatus(id, val) {
            await postAPI('update_order_status', { orderId: id, updates: { status: val } });
            fetchData();
        }
        async function setPayLink(id) {
            const l = prompt("ÊîØÊâï„ÅÑ„É™„É≥„ÇØ (Stripe/Square URL) „ÇíÂÖ•Âäõ:");
            if (l) {
                await postAPI('update_order_status', { orderId: id, updates: { paymentLink: l } });
                fetchData();
            }
        }

        // --- DRAG & DROP STATE ---
        let dragSrc = null;

        function dragStart(e, cat, idx) {
            dragSrc = { cat, idx };
            e.dataTransfer.effectAllowed = 'move';
            e.target.style.opacity = '0.4';
        }

        function dragOver(e) {
            if (e.preventDefault) e.preventDefault();
            e.dataTransfer.dropEffect = 'move';
            return false;
        }

        function dragDrop(e, cat, idx) {
            if (e.stopPropagation) e.stopPropagation();
            if (dragSrc && dragSrc.cat === cat && dragSrc.idx !== idx) {
                // Move item
                const list = DATA[cat];
                const item = list.splice(dragSrc.idx, 1)[0];
                list.splice(idx, 0, item);
                renderPortfolio();
            }
            return false;
        }

        function dragEnd(e) {
            e.target.style.opacity = '1';
        }


        // --- PORTFOLIO UI ---
        function switchPfCat(cat, btn) {
            activePfCat = cat;
            document.querySelectorAll('#tab-portfolio .filter-chip').forEach(c => c.classList.remove('active'));
            btn.classList.add('active');

            ['works', 'mix', 'orig'].forEach(k => document.getElementById(`pf-${k}`).classList.add('hidden'));
            document.getElementById(`pf-${cat}`).classList.remove('hidden');
        }

        function renderPortfolio() {
            renderPfGrid('works', DATA.works);
            renderPfGrid('mix', DATA.mix);
            renderPfGrid('orig', DATA.orig);
        }

        function renderPfGrid(cat, items) {
            const el = document.getElementById(`pf-${cat}`);
            el.innerHTML = '';
            (items || []).forEach((item, idx) => {
                const div = document.createElement('div');
                div.className = 'pf-card';
                div.draggable = true;

                // DnD Events
                div.ondragstart = (e) => dragStart(e, cat, idx);
                div.ondragover = dragOver;
                div.ondrop = (e) => dragDrop(e, cat, idx);
                div.ondragend = dragEnd;

                div.innerHTML = `
                    <div class="pf-thumb"><iframe src="https://www.youtube.com/embed/${item.id}"></iframe></div>
                    <div class="pf-body">
                        <label class="form-label">YouTube ID</label>
                        <input class="form-input" value="${item.id}" onchange="updatePfData('${cat}', ${idx}, 'id', this.value)">
                        <label class="form-label">Title / Comment</label>
                        <input class="form-input" value="${item.title || ''}" onchange="updatePfData('${cat}', ${idx}, 'title', this.value)">
                        
                        <div class="action-bar" style="display:flex; justify-content:space-between; align-items:center;">
                            <div class="sort-controls" style="display:flex; gap:4px; color:#ccc;">
                                <i class="fa-solid fa-grip-vertical" style="cursor:grab;"></i>
                            </div>
                            <button class="btn btn-danger btn-sm" onclick="delPf('${cat}', ${idx})"><i class="fa-regular fa-trash-can"></i> ÂâäÈô§</button>
                        </div>
                    </div>
                `;
                el.appendChild(div);
            });
        }

        function movePfItem(cat, idx, dir) {
            // Legacy button support removed in favor of DnD, but keeping logic if needed? 
            // Removed for clean DnD UI.
        }

        // Helper to extract YouTube ID
        function extractYouTubeId(url) {
            if (!url) return '';
            url = url.trim();
            // If already an ID (11 chars alphanumeric/dash/underscore), return as is
            if (/^[a-zA-Z0-9_-]{11}$/.test(url)) return url;

            // Regex to find ID in URL
            const regExp = /^.*(youtu.be\/|v\/|u\/\w\/|embed\/|watch\?v=|\&v=)([^#\&\?]*).*/;
            const match = url.match(regExp);
            return (match && match[2].length === 11) ? match[2] : url;
        }

        function updatePfData(cat, idx, key, val) {
            if (key === 'id') {
                const cleanId = extractYouTubeId(val);
                DATA[cat][idx][key] = cleanId;
                // Force update UI (to show thumbnail and clean ID)
                renderPortfolio();
            } else {
                DATA[cat][idx][key] = val;
            }
        }
        function addPfItem() {
            if (!DATA[activePfCat]) DATA[activePfCat] = [];
            DATA[activePfCat].push({ id: '', title: '' });
            renderPortfolio();
        }
        function delPf(cat, idx) {
            if (confirm("ÂâäÈô§„Åó„Åæ„Åô„ÅãÔºü")) { DATA[cat].splice(idx, 1); renderPortfolio(); }
        }
        async function savePortfolio() {
            document.getElementById('loading').style.display = 'flex';
            await postAPI('update_portfolio', { category: 'works', items: DATA.works });
            await postAPI('update_portfolio', { category: 'mix', items: DATA.mix });
            await postAPI('update_portfolio', { category: 'orig', items: DATA.orig });
            document.getElementById('loading').style.display = 'none';
            alert("‰øùÂ≠ò„Åó„Åæ„Åó„Åü");
        }

        // Helper: Price Formatter
        function formatPriceInput(input) {
            let val = input.value.replace(/[^0-9]/g, ''); // Remove non-numbers
            if (!val) return;
            // Format: 10,000ÂÜÜ
            input.value = Number(val).toLocaleString() + 'ÂÜÜ';
            DATA.prices[input.dataset.key] = input.value;
        }

        // --- PLANS UI (Dynamic) ---
        function renderPrices() {
            const el = document.getElementById('price-form');
            el.innerHTML = '';

            // Mix Plans
            el.innerHTML += `<div class="flex justify-between items-center mt-4 mb-2">
                                <h4 class="font-bold" style="color:var(--accent-blue);">„Éü„ÉÉ„ÇØ„Çπ„Éª„Éû„Çπ„Çø„É™„É≥„Ç∞ (Mix Plans)</h4>
                                <button class="btn btn-sm btn-ghost" onclick="addPlan('mix')">+ „Éó„É©„É≥ËøΩÂä†</button>
                             </div>`;
            el.innerHTML += `<div id="plans-mix" class="pf-grid" style="grid-template-columns: 1fr;"></div>`;
            renderPlanList('mix');

            // Original Plans
            el.innerHTML += `<div class="flex justify-between items-center mt-8 mb-2">
                                <h4 class="font-bold" style="color:var(--accent-blue);">„Ç™„É™„Ç∏„Éä„É´Ê•ΩÊõ≤Âà∂‰Ωú (Original Plans)</h4>
                                <button class="btn btn-sm btn-ghost" onclick="addPlan('orig')">+ „Éó„É©„É≥ËøΩÂä†</button>
                             </div>`;
            el.innerHTML += `<div id="plans-orig" class="pf-grid" style="grid-template-columns: 1fr;"></div>`;
            renderPlanList('orig');
        }

        function renderPlanList(cat) {
            const list = DATA.prices[cat] || [];
            const container = document.getElementById(`plans-${cat}`);
            container.innerHTML = '';

            list.forEach((plan, idx) => {
                const div = document.createElement('div');
                div.className = 'pf-card';
                div.draggable = true;
                div.style.marginBottom = '15px';

                // DnD
                div.ondragstart = (e) => dragStartPlan(e, cat, idx);
                div.ondragover = dragOver;
                div.ondrop = (e) => dragDropPlan(e, cat, idx);
                div.ondragend = dragEnd;

                div.innerHTML = `
                    <div class="pf-body" style="background:#f9fafb;">
                        <div class="flex justify-between items-center mb-2">
                            <span class="font-bold text-gray">#${idx + 1}</span>
                            <div class="action-bar" style="background:transparent; border:none; padding:0;">
                                <i class="fa-solid fa-grip-vertical mr-2" style="cursor:grab; color:#ccc;"></i>
                                <button class="btn btn-danger btn-sm" onclick="delPlan('${cat}', ${idx})"><i class="fa-regular fa-trash-can"></i></button>
                            </div>
                        </div>
                        <div style="display:grid; grid-template-columns: 1fr 1fr; gap:10px;">
                            <div>
                                <label class="form-label">„Éó„É©„É≥Âêç</label>
                                <input class="form-input" value="${plan.title || ''}" onchange="updatePlan('${cat}', ${idx}, 'title', this.value)">
                            </div>
                            <div>
                                <label class="form-label">‰æ°Ê†º (Ë°®Á§∫Áî®)</label>
                                <input class="form-input" value="${plan.price || ''}" 
                                       onchange="updatePlan('${cat}', ${idx}, 'price', this.value)"
                                       onblur="this.value = formatMoney(this.value); updatePlan('${cat}', ${idx}, 'price', this.value);"
                                       onfocus="this.value = unformatMoney(this.value)">
                            </div>
                            <div>
                                <label class="form-label">Á¥çÊúüÁõÆÂÆâ</label>
                                <input class="form-input" value="${plan.period || ''}" onchange="updatePlan('${cat}', ${idx}, 'period', this.value)">
                            </div>
                            <div>
                                <label class="form-label">‰øÆÊ≠£ÂõûÊï∞„ÉªÁ¥çÂìÅÂΩ¢Âºè</label>
                                <input class="form-input" value="${plan.limit || ''}" placeholder="2Âõû„Åæ„Åß / wav, mp3" onchange="updatePlan('${cat}', ${idx}, 'limit', this.value)">
                            </div>
                        </div>
                        <div class="mt-2">
                            <label class="form-label">Ë©≥Á¥∞Ë™¨Êòé (ÊîπË°åÂèØ)</label>
                            <textarea class="form-input" rows="3" onchange="updatePlan('${cat}', ${idx}, 'desc', this.value)">${plan.desc || ''}</textarea>
                        </div>
                        <div class="mt-2 text-sm">
                             <label class="form-label" style="display:inline-flex; align-items:center;">
                                <input type="checkbox" ${plan.recommended ? 'checked' : ''} onchange="updatePlan('${cat}', ${idx}, 'recommended', this.checked)"> 
                                <span style="margin-left:5px;">„Åä„Åô„Åô„ÇÅ/‰∫∫Ê∞ó„Å®„Åó„Å¶Ë°®Á§∫</span>
                             </label>
                        </div>
                    </div>
                `;
                container.appendChild(div);
            });
        }

        function addPlan(cat) {
            if (!DATA.prices[cat]) DATA.prices[cat] = [];
            DATA.prices[cat].push({ title: 'Êñ∞„Åó„ÅÑ„Éó„É©„É≥', price: '0ÂÜÜ', period: '7Êó•', desc: '' });
            renderPrices();
        }

        function delPlan(cat, idx) {
            if (confirm('ÂâäÈô§„Åó„Åæ„Åô„ÅãÔºü')) {
                DATA.prices[cat].splice(idx, 1);
                renderPrices();
            }
        }

        function updatePlan(cat, idx, key, val) {
            DATA.prices[cat][idx][key] = val;
        }

        // Plan DnD Logic
        function dragStartPlan(e, cat, idx) {
            dragSrc = { cat, idx, type: 'plan' };
            e.dataTransfer.effectAllowed = 'move';
            e.target.style.opacity = '0.4';
        }

        function dragDropPlan(e, cat, idx) {
            if (e.stopPropagation) e.stopPropagation();
            if (dragSrc && dragSrc.type === 'plan' && dragSrc.cat === cat && dragSrc.idx !== idx) {
                const list = DATA.prices[cat];
                const item = list.splice(dragSrc.idx, 1)[0];
                list.splice(idx, 0, item);
                renderPrices();
            }
            return false;
        }

        // Money Utils
        function formatMoney(val) {
            if (!val) return '';
            val = val.replace(/[^0-9]/g, '');
            return val ? Number(val).toLocaleString() + 'ÂÜÜ' : '';
        }
        function unformatMoney(val) {
            return val.replace(/[^0-9]/g, '');
        }

        async function savePrices() {
            document.getElementById('loading').style.display = 'flex';
            await postAPI('update_prices', DATA.prices);
            document.getElementById('loading').style.display = 'none';
            alert("ÊñôÈáë„Éó„É©„É≥„Çí‰øùÂ≠ò„Åó„Åæ„Åó„Åü");
        }

        // --- VOICES UI ---
        function renderVoices() {
            const list = DATA.voices || [];
            const container = document.getElementById('voice-list');
            container.innerHTML = '';

            list.forEach((v, idx) => {
                const div = document.createElement('div');
                div.className = 'pf-card';
                div.innerHTML = `
                     <div class="pf-body" style="background:#f9fafb;">
                        <div class="flex justify-between items-center mb-2">
                            <span class="font-bold text-gray">#${idx + 1}</span>
                            <button class="btn btn-danger btn-sm" onclick="delVoice(${idx})"><i class="fa-regular fa-trash-can"></i></button>
                        </div>
                        <div style="display:grid; grid-template-columns: 1fr 2fr; gap:10px;">
                            <div>
                                <label class="form-label">ÂêçÂâç</label>
                                <input class="form-input" value="${v.name || ''}" onchange="updateVoice(${idx}, 'name', this.value)">
                            </div>
                            <div>
                                <label class="form-label">„Ç¢„Ç§„Ç≥„É≥ (Emoji or URL)</label>
                                <input class="form-input" value="${v.icon || ''}" placeholder="üòä or https://..." onchange="updateVoice(${idx}, 'icon', this.value)">
                            </div>
                        </div>
                        <div class="mt-2">
                                <label class="form-label">ÊÑüÊÉ≥„Ç≥„É°„É≥„Éà</label>
                                <textarea class="form-input" rows="2" onchange="updateVoice(${idx}, 'text', this.value)">${v.text || ''}</textarea>
                        </div>
                     </div>
                `;
                container.appendChild(div);
            });
        }

        function addVoice() {
            if (!DATA.voices) DATA.voices = [];
            DATA.voices.push({ name: 'User', text: 'ÊÑüÊÉ≥...', icon: 'üòä' });
            renderVoices();
        }

        function updateVoice(idx, key, val) {
            DATA.voices[idx][key] = val;
        }

        function delVoice(idx) {
            if (confirm('ÂâäÈô§„Åó„Åæ„Åô„ÅãÔºü')) {
                DATA.voices.splice(idx, 1);
                renderVoices();
            }
        }

        async function saveVoices() {
            document.getElementById('loading').style.display = 'flex';
            // We use generic update logic. Need to add 'update_voices' to api? 
            // Or just reuse update_prices logic? No, update_prices updates site_prices kv.
            // We need a way to save voices. 
            // api/admin.js supports: update_pf (DATA.works/mix/orig), update_prices (DATA.prices).
            // We need update_voices.
            await postAPI('update_voices', DATA.voices);
            document.getElementById('loading').style.display = 'none';
            alert("Â£∞„Çí‰øùÂ≠ò„Åó„Åæ„Åó„Åü");
        }

        // --- API UTILS ---
        async function postAPI(action, data) {
            await fetch('/api/admin', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json', 'x-admin-password': TOKEN },
                body: JSON.stringify({ action, data })
            });
        }

        // Init
        checkAuth();

        // --- MODAL UTILS ---
        function openOrderDetail(id) {
            // ... (keeping exiting logic but updating if needed)
            const order = DATA.orders.find(o => o.id === id);
            // ...
        }

        // ...

        // Updated Status Class Logic
        function getStatusClass(s) {
            if (s === 'Êú™ÁùÄÊâã') return 'bg-gray-100';
            if (s === 'ÊîØÊâï„ÅÑÂæÖ„Å°') return 'bg-orange-100';
            if (s === 'ÂÖ®„Å¶ÂÖ•ÈáëÊ∏à„Åø') return 'bg-green-100';
            if (s === 'Á¥çÂìÅÊ∏à„Åø') return 'bg-blue-100'; // Added
            if (s === 'ÂèñÂºïÁµÇ‰∫Ü') return 'bg-gray-100';
            if (s === '„Ç≠„É£„É≥„Çª„É´') return 'bg-red-100';
            return 'bg-blue-100';
        }

        // ...

        // PLAN MAPPING
        const PLAN_MAP = {
            'standard': '„Çπ„Çø„É≥„ÉÄ„Éº„Éâ„Éó„É©„É≥',
            'one_chorus': '„ÉØ„É≥„Ç≥„Éº„É©„Çπ„Éó„É©„É≥',
            'short': '„Ç∑„Éß„Éº„ÉàÂãïÁîªÁî®MIX',
            'speed': '„Çπ„Éî„Éº„Éâ„Éó„É©„É≥',
            'super_speed': 'Ë∂Ö„Çπ„Éî„Éº„Éâ„Éó„É©„É≥',
            'collab': '„Ç≥„É©„Éú„ÉªÂêàÂî±„Éó„É©„É≥',
            'original_std': '„Ç™„É™„Ç∏„Éä„É´Ê•ΩÊõ≤ „Çπ„Çø„É≥„ÉÄ„Éº„Éâ',
            'original_lyrics': '„Ç™„É™„Ç∏„Éä„É´Ê•ΩÊõ≤ ‰ΩúË©ûÊåÅ„Å°Ëæº„Åø',
            'other': '„Åù„ÅÆ‰ªñ„Éª„ÅîÁõ∏Ë´á'
        };
        const PAY_MAP = {
            'bank_transfer': 'ÈäÄË°åÊåØËæº',
            'credit_card': '„ÇØ„É¨„Ç∏„ÉÉ„Éà„Ç´„Éº„Éâ'
        };

        // --- ORDER DETAIL PAGE ---
        function showOrderDetail(id) {
            const order = DATA.orders.find(o => o.id === id);
            if (!order) return;

            // Switch View
            document.querySelectorAll('.tab-pane').forEach(el => el.classList.add('hidden'));
            document.getElementById('tab-order-detail').classList.remove('hidden');
            window.scrollTo(0, 0);

            // Container
            const container = document.getElementById('detail-content');

            const fields = [
                { label: 'ÂèóÊ≥®ID', val: order.id },
                { label: '„Åî‰æùÈ†ºÊó•', val: new Date(order.date).toLocaleString('ja-JP') },
                { label: '„Çπ„ÉÜ„Éº„Çø„Çπ', val: `<span class="status-badge ${getStatusClass(order.status)}">${order.status}</span>`, type: 'html' },
                { separator: true },
                { label: '„Åî‰æùÈ†ºËÄÖÂêç', val: order['„Åî‰æùÈ†ºËÄÖÂêç'] },
                { label: '„É°„Éº„É´„Ç¢„Éâ„É¨„Çπ', val: order['„É°„Éº„É´„Ç¢„Éâ„É¨„Çπ'] },
                { label: 'Twitter ID', val: order['TwitterID(‰ªªÊÑè)'] },
                { label: 'Â∏åÊúõÈÄ£Áµ°ÊâãÊÆµ', val: order['Â∏åÊúõ„Åô„ÇãÈÄ£Áµ°ÊâãÊÆµ'] },
                { separator: true },
                { label: '„Éó„É©„É≥', val: PLAN_MAP[order['„Éó„É©„É≥']] || order['„Éó„É©„É≥'] },
                { label: 'Êõ≤Âêç', val: order['Êõ≤Âêç'] },
                { label: '„Ç™„Éó„Ç∑„Éß„É≥', val: order['„Ç™„Éó„Ç∑„Éß„É≥'] || '„Å™„Åó' },
                { label: 'Ê≠åÂî±„Ç≠„Éº', val: order['„Ç≠„ÉºÂ§âÊõ¥'] },
                { label: '„ÅäÊîØÊâï„ÅÑÊñπÊ≥ï', val: PAY_MAP[order['„ÅäÊîØÊâï„ÅÑÊñπÊ≥ï']] || order['„ÅäÊîØÊâï„ÅÑÊñπÊ≥ï'] },
                { separator: true },
                { label: 'ÂèÇËÄÉURL', val: order['ÂèÇËÄÉURL(‰ªªÊÑè)'], type: 'link' },
                { label: '„É¨„Ç≥„Éº„Éá„Ç£„É≥„Ç∞Èü≥Ê∫ê', val: order['„É¨„Ç≥„Éº„Éá„Ç£„É≥„Ç∞Ê∏à„ÅøÈü≥Ê∫ê'], type: 'link' },
                { label: '„ÅîË¶ÅÊúõ„ÉªÁâπË®ò‰∫ãÈ†Ö', val: order['„ÅîË¶ÅÊúõ„Éª„ÅîË≥™Âïè„ÉªÁâπË®ò‰∫ãÈ†Ö„Å™„Å©'] || '„Å™„Åó', type: 'text' }
            ];

            container.innerHTML = fields.map(f => {
                if (f.separator) return '<hr style="margin: 20px 0; border: 0; border-top: 1px solid #eee;">';

                let displayVal = f.val;
                if (!displayVal || displayVal === '„Å™„Åó') {
                    displayVal = '<span style="color:#ccc;">(Êú™ÂÖ•Âäõ/„Å™„Åó)</span>';
                } else if (f.type === 'link') {
                    displayVal = `<a href="${f.val}" target="_blank">${f.val}</a>`;
                } else if (f.type === 'text') {
                    displayVal = `<div style="white-space: pre-wrap; background:#f9fafb; padding:10px; border-radius:6px;">${f.val}</div>`;
                }

                return `
                    <div class="detail-row" style="grid-template-columns: 200px 1fr;">
                        <div class="detail-label">${f.label}</div>
                        <div class="detail-value">${f.type === 'html' ? f.val : displayVal}</div>
                    </div>
                `;
            }).join('');
        }

        function backToOrders() {
            switchTab('orders');
        }
    </script>
</body>

</html>