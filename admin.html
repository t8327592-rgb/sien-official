<!DOCTYPE html>
<html lang="ja">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Dashboard | Sien-Official</title>
    <!-- Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link
        href="https://fonts.googleapis.com/css2?family=Jost:wght@400;500;600&family=Noto+Sans+JP:wght@400;500;700&display=swap"
        rel="stylesheet">
    <!-- Icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

    <style>
        :root {
            --primary: #4A90E2;
            --bg-color: #f3f4f6;
            --text-main: #333;
            --text-muted: #666;
            --border-color: #e5e7eb;
            --white: #ffffff;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Jost', 'Noto Sans JP', sans-serif;
        }

        body {
            background-color: var(--bg-color);
            color: var(--text-main);
            min-height: 100vh;
            display: flex;
            flex-direction: column;
        }

        /* HEADER */
        .admin-header {
            background: var(--white);
            height: 60px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 0 40px;
            border-bottom: 1px solid var(--border-color);
        }

        .brand {
            font-weight: 700;
            font-size: 1.2rem;
            letter-spacing: 0.05em;
            display: flex;
            align-items: center;
            gap: 10px;
            color: #000;
            text-decoration: none;
        }

        .brand span {
            color: var(--text-muted);
            font-size: 0.9rem;
            font-weight: 400;
        }

        .brand img {
            height: 24px;
        }

        .user-menu {
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .user-avatar {
            width: 32px;
            height: 32px;
            background: #ddd;
            border-radius: 50%;
            overflow: hidden;
        }

        .user-avatar img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        /* SUB NAV */
        .sub-nav {
            background: var(--white);
            border-bottom: 1px solid var(--border-color);
            padding: 0 40px;
            display: flex;
            gap: 30px;
        }

        .nav-tab {
            padding: 15px 5px;
            font-size: 0.9rem;
            color: var(--text-muted);
            cursor: pointer;
            position: relative;
            transition: color 0.2s;
        }

        .nav-tab:hover {
            color: var(--primary);
        }

        .nav-tab.active {
            color: var(--primary);
            font-weight: 600;
        }

        .nav-tab.active::after {
            content: '';
            position: absolute;
            bottom: -1px;
            left: 0;
            width: 100%;
            height: 2px;
            background: var(--primary);
        }

        /* MAIN */
        .main-container {
            flex: 1;
            padding: 30px 40px;
            max-width: 1400px;
            margin: 0 auto;
            width: 100%;
        }

        .breadcrumb {
            font-size: 0.85rem;
            color: var(--primary);
            margin-bottom: 20px;
        }

        .breadcrumb span {
            color: var(--text-muted);
        }

        .page-header {
            display: flex;
            align-items: center;
            gap: 15px;
            margin-bottom: 20px;
        }

        .page-title {
            font-size: 1.25rem;
            font-weight: 700;
        }

        .badge-rank {
            font-size: 0.8rem;
            background: #e0e7ff;
            color: #4338ca;
            padding: 2px 8px;
            border-radius: 4px;
        }

        .content-card {
            background: var(--white);
            border-radius: 8px;
            padding: 25px;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.05);
            min-height: 600px;
        }

        .tab-pane {
            display: none;
        }

        .tab-pane.active {
            display: block;
        }

        /* FILTER */
        .filter-section {
            display: flex;
            flex-direction: column;
            gap: 15px;
            margin-bottom: 20px;
            border-bottom: 1px solid #eee;
            padding-bottom: 20px;
        }

        .search-row {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .search-input-group {
            display: flex;
            border: 1px solid #ddd;
            border-radius: 4px;
            overflow: hidden;
            width: 300px;
        }

        .search-prefix {
            background: var(--primary);
            color: white;
            padding: 8px 12px;
            font-size: 0.9rem;
            font-weight: 600;
            white-space: nowrap;
        }

        .search-input {
            border: none;
            padding: 8px 12px;
            outline: none;
            width: 100%;
            font-size: 0.9rem;
        }

        .status-tabs {
            display: flex;
            gap: 20px;
            font-size: 0.9rem;
            color: #666;
            margin-top: 10px;
        }

        .status-tab {
            cursor: pointer;
            position: relative;
            padding-bottom: 5px;
        }

        .status-tab:hover {
            color: var(--primary);
        }

        .status-tab.active {
            color: var(--primary);
            font-weight: 700;
            border-bottom: 2px solid var(--primary);
        }

        .count-badge {
            margin-left: 4px;
            font-size: 0.8em;
            color: #999;
        }

        /* TABLE */
        .admin-table {
            width: 100%;
            border-collapse: collapse;
            font-size: 0.9rem;
        }

        .admin-table th {
            text-align: left;
            padding: 12px 10px;
            font-weight: 600;
            color: #666;
            border-bottom: 1px solid #eee;
            white-space: nowrap;
        }

        .admin-table td {
            padding: 15px 10px;
            border-bottom: 1px solid #f9f9f9;
            vertical-align: middle;
        }

        .client-name {
            font-weight: 600;
            color: #333;
        }

        .plan-name {
            font-size: 0.85rem;
            color: #666;
        }

        .pay-link {
            color: var(--primary);
            text-decoration: none;
            font-weight: 500;
            font-size: 0.85rem;
        }

        .pay-link:hover {
            text-decoration: underline;
        }

        .status-btn {
            background: #9ca3af;
            color: white;
            border: none;
            padding: 5px 12px;
            border-radius: 4px;
            font-size: 0.8rem;
            cursor: pointer;
            transition: background 0.2s;
        }

        .status-btn.done {
            background: #888;
        }

        .status-btn.active {
            background: var(--primary);
        }

        .status-badge {
            border: 1px solid #ddd;
            padding: 4px;
            border-radius: 4px;
            font-size: 0.85rem;
        }

        /* PF GRID */
        .pf-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
            gap: 20px;
        }

        .pf-item {
            border: 1px solid #eee;
            border-radius: 8px;
            overflow: hidden;
            background: #fff;
        }

        .pf-thumb {
            height: 170px;
            background: #000;
            position: relative;
        }

        .pf-thumb iframe {
            width: 100%;
            height: 100%;
            border: none;
        }

        .pf-inputs {
            padding: 15px;
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .pf-input {
            width: 100%;
            padding: 8px;
            border: 1px solid #eee;
            border-radius: 4px;
            font-size: 0.85rem;
        }

        /* PRICES */
        .price-stack {
            display: flex;
            flex-direction: column;
            gap: 30px;
            max-width: 800px;
            margin: 0 auto;
        }

        .price-group {
            border-bottom: 1px solid #eee;
            padding-bottom: 30px;
        }

        .price-row {
            display: flex;
            gap: 15px;
            margin-bottom: 10px;
        }

        .price-input-lg {
            font-size: 1.1rem;
            font-weight: 600;
            padding: 8px;
            width: 100%;
        }

        /* FOOTER */
        .admin-footer {
            background: #1f2937;
            color: #d1d5db;
            padding: 40px;
            margin-top: auto;
            font-size: 0.85rem;
        }

        .footer-cols {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 40px;
            max-width: 1200px;
            margin: 0 auto;
        }

        .footer-col h4 {
            color: white;
            margin-bottom: 15px;
            font-size: 0.9rem;
        }

        .footer-col ul {
            list-style: none;
        }

        .footer-col li {
            margin-bottom: 8px;
        }

        .footer-col a {
            color: #9ca3af;
            text-decoration: none;
        }

        .footer-col a:hover {
            color: white;
        }

        button:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }
    </style>
</head>

<body>
    <!-- AUTH -->
    <div id="auth-screen"
        style="position:fixed; top:0; left:0; width:100%; height:100%; background:#f3f4f6; z-index:9999; display:flex; align-items:center; justify-content:center;">
        <div
            style="background:white; padding:40px; border-radius:8px; width:350px; text-align:center; box-shadow:0 10px 25px rgba(0,0,0,0.05);">
            <h2 style="font-weight:700; margin-bottom:20px;">Sien-Official</h2>
            <input type="password" id="auth-pass" placeholder="Password"
                style="width:100%; padding:10px; margin-bottom:15px; border:1px solid #ddd; border-radius:4px;">
            <button onclick="login()" class="btn btn-primary" style="width:100%;">Login</button>
        </div>
    </div>

    <header class="admin-header">
        <a href="#" class="brand">
            <img src="./assets/logo.png" alt="Logo">
            <span>|</span>
            <span>Studio</span>
        </a>
        <div class="user-menu">
            <span style="font-size:0.9rem;">Admin User</span>
            <div class="user-avatar">
                <img src="https://ui-avatars.com/api/?name=Admin&background=random" alt="User">
            </div>
            <button onclick="logout()" class="btn btn-sm" style="background:#eee;">Logout</button>
        </div>
    </header>

    <nav class="sub-nav">
        <div class="nav-tab active" onclick="switchTab('orders', this)">‰æùÈ†ºÁÆ°ÁêÜ</div>
        <div class="nav-tab" onclick="switchTab('portfolio', this)">„Éù„Éº„Éà„Éï„Ç©„É™„Ç™</div>
        <div class="nav-tab" onclick="switchTab('prices', this)">„Éó„É©„É≥„ÉªÊñôÈáëË®≠ÂÆö</div>
        <div class="nav-tab" onclick="switchTab('account', this)">„Ç¢„Ç´„Ç¶„É≥„ÉàË®≠ÂÆö</div>
    </nav>

    <main class="main-container">
        <div class="breadcrumb">
            „Éû„Ç§„Éö„Éº„Ç∏TOP > <span id="page-crumb">‰æùÈ†ºÁÆ°ÁêÜ</span>
        </div>

        <section class="content-card">
            <!-- ORDERS TAB -->
            <div id="tab-orders" class="tab-pane active">
                <div class="page-header">
                    <div class="page-title">‰æùÈ†ºÁÆ°ÁêÜ</div>
                    <span class="badge-rank">„ÇØ„É™„Ç®„Ç§„Çø„Éº„É©„É≥„ÇØÔºö„Ç∑„É´„Éê„Éº ü•à</span>
                </div>

                <div class="filter-section">
                    <div class="search-row">
                        <div class="search-input-group">
                            <div class="search-prefix"><i class="fa-solid fa-folder"></i> = „Åæ„Å®„ÇÅ„Å¶‰æùÈ†º</div>
                            <input type="text" class="search-input" placeholder="‰æùÈ†ºËÄÖÂêç„ÅßÁµû„ÇäËæº„Åø"
                                onkeyup="renderOrders(this.value)">
                        </div>
                    </div>
                    <div class="status-tabs">
                        <div class="status-tab active" onclick="setFilter('all', this)">ÂÖ®„Å¶(<span id="cnt-all">0</span>)
                        </div>
                        <div class="status-tab" onclick="setFilter('Êú™ÁùÄÊâã', this)">Êú™ÁùÄÊâã(<span id="cnt-new">0</span>)</div>
                        <div class="status-tab" onclick="setFilter('ÊîØÊâï„ÅÑÂæÖ„Å°', this)">ÊîØÊâï„ÅÑÂæÖ„Å°(<span id="cnt-pay">0</span>)
                        </div>
                        <div class="status-tab" onclick="setFilter('ÂÖ®„Å¶ÂÖ•ÈáëÊ∏à„Åø', this)">ÂÖ•ÈáëÊ∏à„Åø(<span id="cnt-paid">0</span>)
                        </div>
                        <div class="status-tab" onclick="setFilter('Á¥çÂìÅÊ∏à„Åø', this)">Á¥çÂìÅÊ∏à„Åø(<span id="cnt-done">0</span>)
                        </div>
                        <div class="status-tab" onclick="setFilter('ÂèñÂºïÁµÇ‰∫Ü', this)">ÂèñÂºïÁµÇ‰∫Ü(<span id="cnt-closed">0</span>)
                        </div>
                        <div class="status-tab" onclick="setFilter('archive', this)">„Ç≠„É£„É≥„Çª„É´(<span
                                id="cnt-cancel">0</span>)</div>
                    </div>
                </div>

                <table class="admin-table">
                    <thead>
                        <tr>
                            <th>„Åî‰æùÈ†ºÊó•</th>
                            <th>Êõ≤Âêç</th>
                            <th>„Åî‰æùÈ†ºËÄÖÂêç</th>
                            <th>„Éó„É©„É≥</th>
                            <th>ÊîØÊâï„ÅÑ„É™„É≥„ÇØ</th>
                            <th>Á¥çÊúü <i class="fa-solid fa-gear" style="color:var(--primary);"></i></th>
                            <th>Á¥çÂìÅÂÆå‰∫Ü/„Ç≠„É£„É≥„Çª„É´</th>
                            <th>„Çπ„ÉÜ„Éº„Çø„Çπ</th>
                        </tr>
                    </thead>
                    <tbody id="order-tbody"></tbody>
                </table>
            </div>

            <!-- PORTFOLIO TAB -->
            <div id="tab-portfolio" class="tab-pane">
                <div class="page-header" style="justify-content:space-between;">
                    <div class="page-title">„Éù„Éº„Éà„Éï„Ç©„É™„Ç™Ë®≠ÂÆö</div>
                    <button class="btn btn-primary" onclick="savePf()">‰øùÂ≠ò„Åô„Çã</button>
                </div>
                <div class="mb-4">
                    <button class="btn" style="background:#eee;" onclick="addPf()">+ ËøΩÂä†</button>
                    <select id="pf-cat-select" onchange="renderPf()" style="padding:5px; margin-left:10px;">
                        <option value="works">Âà∂‰ΩúÂÆüÁ∏æ (Works)</option>
                        <option value="mix">„Éü„ÉÉ„ÇØ„Çπ (Mix)</option>
                        <option value="orig">„Ç™„É™„Ç∏„Éä„É´ (Original)</option>
                    </select>
                </div>
                <div id="pf-container" class="pf-grid"></div>
            </div>

            <!-- PRICES TAB -->
            <div id="tab-prices" class="tab-pane">
                <div class="page-header" style="justify-content:space-between;">
                    <div class="page-title">„Éó„É©„É≥„ÉªÊñôÈáëË®≠ÂÆö</div>
                    <button class="btn btn-primary" onclick="savePrices()">‰øùÂ≠ò„Åô„Çã</button>
                </div>
                <div id="price-container" class="price-stack"></div>
                <div style="text-align:center; margin-top:30px;">
                    <button class="btn" style="background:#eee;" onclick="addPlan()">+ „Éó„É©„É≥„ÇíËøΩÂä†</button>
                </div>
            </div>

            <div id="tab-account" class="tab-pane">
                <div class="page-title">„Ç¢„Ç´„Ç¶„É≥„ÉàË®≠ÂÆö</div>
                <p>Not implemented yet.</p>
            </div>
        </section>
    </main>

    <footer class="admin-footer">
        <div class="footer-cols">
            <div class="footer-col">
                <h4>„Ç´„ÉÜ„Ç¥„É™„Éº‰∏ÄË¶ß</h4>
                <ul>
                    <li><a href="#">Mix & Mastering</a></li>
                </ul>
            </div>
            <div class="footer-col">
                <h4>„Éó„É©„É≥‰∏ÄË¶ß</h4>
                <ul>
                    <li><a href="#">„Çπ„Çø„É≥„ÉÄ„Éº„Éâ„Éó„É©„É≥</a></li>
                </ul>
            </div>
            <div class="footer-col" style="grid-column: span 2;">
                <div style="background:white; color:#333; padding:20px; border-radius:4px;">
                    <p style="font-weight:bold; margin-bottom:10px;">ÈÅãÂñ∂„Å∏„ÅÆ„ÅîÊÑèË¶ã„ÉªË¶ÅÊúõ</p>
                    <textarea style="width:100%; border:1px solid #ddd; padding:10px; height:80px;"></textarea>
                    <button class="btn btn-primary" style="width:100%; margin-top:10px;">ÈÄÅ‰ø°„Åô„Çã</button>
                </div>
            </div>
        </div>
        <div style="text-align:center; margin-top:40px; border-top:1px solid #374151; padding-top:20px;">
            Copyright (c) 2026 Sien-Official. All Rights Reserved.
        </div>
    </footer>

    <script>
        let TOKEN = localStorage.getItem('admin_token') || '';
        let DATA = { orders: [], works: [], mix: [], orig: [], prices: { mix: [], orig: [] } };
        let activePfCat = 'works';

        function checkAuth() {
            if (TOKEN) {
                document.getElementById('auth-screen').style.display = 'none';
                fetchData();
            }
        }
        async function login() {
            const pass = document.getElementById('auth-pass').value;
            try {
                const res = await fetch('/api/admin', { headers: { 'x-admin-password': pass } });
                if (res.ok) {
                    TOKEN = pass;
                    localStorage.setItem('admin_token', pass);
                    checkAuth();
                } else alert("Invalid Password");
            } catch (e) { alert("Error"); }
        }
        function logout() { localStorage.removeItem('admin_token'); location.reload(); }

        async function fetchData() {
            try {
                const res = await fetch('/api/admin', { headers: { 'x-admin-password': TOKEN } });
                if (res.status === 401) { logout(); return; }
                const json = await res.json();
                DATA = { ...DATA, ...json };

                if (Array.isArray(DATA.prices)) DATA.prices = { mix: [], orig: [] };
                if (!DATA.prices.mix) DATA.prices.mix = [];
                if (!DATA.prices.orig) DATA.prices.orig = [];
                if (!DATA.archive) DATA.archive = [];

                renderOrders();
                renderPf();
                renderPrices();
            } catch (e) { console.error(e); }
        }

        async function postAPI(action, data) {
            await fetch('/api/admin', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json', 'x-admin-password': TOKEN },
                body: JSON.stringify({ action, data })
            });
        }

        function switchTab(tabId, el) {
            document.querySelectorAll('.tab-pane').forEach(d => d.classList.remove('active'));
            document.getElementById('tab-' + tabId).classList.add('active');

            document.querySelectorAll('.nav-tab').forEach(t => t.classList.remove('active'));
            el.classList.add('active');

            const map = { 'orders': '‰æùÈ†ºÁÆ°ÁêÜ', 'portfolio': '„Éù„Éº„Éà„Éï„Ç©„É™„Ç™', 'prices': '„Éó„É©„É≥Ë®≠ÂÆö', 'account': '„Ç¢„Ç´„Ç¶„É≥„Éà' };
            document.getElementById('page-crumb').innerText = map[tabId];
        }

        // --- ORDERS LOGIC ---
        let filterStatus = 'all';

        function setFilter(stat, el) {
            filterStatus = stat;
            document.querySelectorAll('.status-tab').forEach(t => t.classList.remove('active'));
            el.classList.add('active');
            renderOrders();
        }

        function renderOrders(query = '') {
            const tbody = document.getElementById('order-tbody');
            tbody.innerHTML = '';

            let list = [];
            let isArchive = (filterStatus === 'archive' || filterStatus === 'cancel');

            if (isArchive) {
                const archived = DATA.archive || [];
                const cancelled = (DATA.orders || []).filter(o => o.status === '„Ç≠„É£„É≥„Çª„É´');
                list = [...archived, ...cancelled];
            } else {
                list = DATA.orders || [];
                if (filterStatus !== 'all') {
                    list = list.filter(o => o.status === filterStatus);
                } else {
                    list = list.filter(o => o.status !== '„Ç≠„É£„É≥„Çª„É´' && o.status !== 'archived');
                }
            }

            if (query) {
                list = list.filter(o => (o['„Åî‰æùÈ†ºËÄÖÂêç'] || '').includes(query) || (o['Êõ≤Âêç'] || '').includes(query));
            }

            list.sort((a, b) => new Date(b.date) - new Date(a.date));

            const counts = { 'archive': (DATA.archive || []).length };
            (DATA.orders || []).forEach(o => counts[o.status] = (counts[o.status] || 0) + 1);

            ['Êú™ÁùÄÊâã', 'ÊîØÊâï„ÅÑÂæÖ„Å°', 'ÂÖ®„Å¶ÂÖ•ÈáëÊ∏à„Åø', 'Á¥çÂìÅÊ∏à„Åø', 'ÂèñÂºïÁµÇ‰∫Ü'].forEach(k => {
                const el = document.getElementById('cnt-' + (k === 'ÂÖ®„Å¶ÂÖ•ÈáëÊ∏à„Åø' ? 'paid' : k === 'Êú™ÁùÄÊâã' ? 'new' : k === 'ÊîØÊâï„ÅÑÂæÖ„Å°' ? 'pay' : k === 'Á¥çÂìÅÊ∏à„Åø' ? 'done' : 'closed'));
                if (el) el.innerText = counts[k] || 0;
            });
            document.getElementById('cnt-all').innerText = (DATA.orders || []).length;
            document.getElementById('cnt-cancel').innerText = (counts['„Ç≠„É£„É≥„Çª„É´'] || 0) + (counts['archive'] || 0);

            list.forEach(order => {
                const realIndex = (DATA.orders || []).findIndex(o => o.id === order.id);
                const archiveIndex = (DATA.archive || []).findIndex(a => a.id === order.id);
                const isItemArchived = Boolean(DATA.archive && DATA.archive.find(a => a.id === order.id));

                const tr = document.createElement('tr');
                tr.innerHTML = `
                    <td>${new Date(order.date).toLocaleDateString('ja-JP')}</td>
                    <td class="client-name">${order['Êõ≤Âêç']}</td>
                    <td>${order['„Åî‰æùÈ†ºËÄÖÂêç']}</td>
                    <td class="plan-name">${order['„Éó„É©„É≥']}</td>
                    <td>
                        <a href="#" class="pay-link" onclick="promptPayLink('${order.id}')">¬• ÊîØÊâï„ÅÑ„É™„É≥„ÇØ</a> 
                        <span style="font-size:0.8em; margin-left:5px;">${order.paymentLink ? '<i class="fa-solid fa-check" style="color:var(--primary);"></i>' : 'Êú™'}</span>
                    </td>
                    <td>
                        <input type="date" value="${order.deadline || ''}" 
                            style="border:none; background:transparent; font-family:inherit; cursor:pointer; color:#666;"
                            onchange="updateDeadline('${order.id}', this.value)">
                    </td>
                     <td>
                        ${isItemArchived ?
                        `<button class="status-btn active" onclick="restoreOrder(${archiveIndex}, '${order.id}')">Âæ©ÂÖÉ</button>` :
                        `<button class="status-btn" onclick="archiveOrder(${realIndex}, '${order.id}')">ÁµÇ‰∫Ü/„Ç≠„É£„É≥„Çª„É´</button>`
                    }
                    </td>
                    <td>
                         ${isItemArchived ? '<span class="count-badge">„Ç¢„Éº„Ç´„Ç§„Éñ</span>' :
                        `<select onchange="updateStatus('${order.id}', this.value)" class="status-badge" style="background:#fff;">
                              ${['Êú™ÁùÄÊâã', 'ÊîØÊâï„ÅÑÂæÖ„Å°', 'ÂÖ®„Å¶ÂÖ•ÈáëÊ∏à„Åø', 'Á¥çÂìÅÊ∏à„Åø', 'ÂèñÂºïÁµÇ‰∫Ü', '„Ç≠„É£„É≥„Çª„É´'].map(s =>
                            `<option value="${s}" ${order.status === s ? 'selected' : ''}>${s}</option>`
                        ).join('')}
                           </select>`
                    }
                    </td>
                `;
                tbody.appendChild(tr);
            });
        }

        async function promptPayLink(id) {
            const order = [...(DATA.orders || []), ...(DATA.archive || [])].find(o => o.id === id);
            if (!order) return;
            const link = prompt("ÊîØÊâï„ÅÑ„É™„É≥„ÇØ„ÇíÂÖ•Âäõ:", order.paymentLink || "");
            if (link !== null) {
                await postAPI('update_order_status', { orderId: id, updates: { paymentLink: link } });
                order.paymentLink = link;
                renderOrders();
            }
        }

        async function updateStatus(id, status) {
            await postAPI('update_order_status', { orderId: id, status: status });
            const order = DATA.orders.find(o => o.id === id);
            if (order) order.status = status;
            renderOrders();
        }

        async function updateDeadline(id, date) {
            await postAPI('update_order_status', { orderId: id, deadline: date });
            const order = DATA.orders.find(o => o.id === id);
            if (order) order.deadline = date;
        }

        async function archiveOrder(idx, id) {
            if (!confirm("„Åì„ÅÆ‰æùÈ†º„ÇíÁµÇ‰∫Ü/„Ç≠„É£„É≥„Çª„É´Ôºà„Ç¢„Éº„Ç´„Ç§„ÉñÔºâ„Åó„Åæ„Åô„ÅãÔºü")) return;
            if (idx === -1) idx = DATA.orders.findIndex(o => o.id === id);
            if (idx === -1) return;

            const item = DATA.orders.splice(idx, 1)[0];
            item.status = 'archived';
            DATA.archive.unshift(item);
            renderOrders();

            await postAPI('archive_order', { index: idx });
        }

        async function restoreOrder(idx, id) {
            if (!confirm("„Åì„ÅÆ‰æùÈ†º„ÇíÂæ©ÂÖÉ„Åó„Åæ„Åô„ÅãÔºü")) return;
            if (idx === -1) idx = DATA.archive.findIndex(o => o.id === id);
            if (idx === -1) return;

            const item = DATA.archive.splice(idx, 1)[0];
            item.status = 'Êú™ÁùÄÊâã';
            DATA.orders.unshift(item);
            renderOrders();

            await postAPI('restore_order', { index: idx });
        }

        // --- PORTFOLIO ---
        function renderPf() {
            activePfCat = document.getElementById('pf-cat-select').value;
            const list = DATA[activePfCat] || [];
            const container = document.getElementById('pf-container');
            container.innerHTML = '';

            list.forEach((item, idx) => {
                const div = document.createElement('div');
                div.className = 'pf-item';
                div.innerHTML = `
                    <div class="pf-thumb">
                        ${item.id ? `<iframe src="https://www.youtube.com/embed/${item.id}" loading="lazy"></iframe>` : ''}
                    </div>
                    <div class="pf-inputs">
                        <input class="pf-input" placeholder="YouTube ID" value="${item.id || ''}" onchange="updatePf(${idx}, 'id', this.value)">
                        <input class="pf-input" placeholder="Title" value="${item.title || ''}" onchange="updatePf(${idx}, 'title', this.value)">
                         <button class="btn btn-sm" style="background:#fee; color:red;" onclick="delPf(${idx})">ÂâäÈô§</button>
                    </div>
                `;
                container.appendChild(div);
            });
        }
        function updatePf(idx, k, v) {
            if (k === 'id') {
                const reg = /^.*(youtu.be\/|v\/|u\/\w\/|embed\/|watch\?v=|\&v=)([^#\&\?]*).*/;
                const m = v.match(reg);
                if (m && m[2].length === 11) v = m[2];
            }
            DATA[activePfCat][idx][k] = v;
            if (k === 'id') renderPf();
        }
        function addPf() { if (!DATA[activePfCat]) DATA[activePfCat] = []; DATA[activePfCat].push({ id: '' }); renderPf(); }
        function delPf(idx) { DATA[activePfCat].splice(idx, 1); renderPf(); }
        async function savePf() {
            await postAPI('update_portfolio', { category: activePfCat, items: DATA[activePfCat] });
            alert("Saved Portfolio");
        }

        // --- PRICES ---
        function renderPrices() {
            const container = document.getElementById('price-container');
            container.innerHTML = '';

            ['mix', 'orig'].forEach(cat => {
                const header = document.createElement('h3');
                header.innerText = cat === 'mix' ? '„Éü„ÉÉ„ÇØ„Çπ„Éó„É©„É≥' : '„Ç™„É™„Ç∏„Éä„É´Âà∂‰Ωú„Éó„É©„É≥';
                header.style.marginTop = '30px';
                container.appendChild(header);

                const list = DATA.prices[cat] || [];
                list.forEach((plan, idx) => {
                    const div = document.createElement('div');
                    div.className = 'price-group';
                    div.innerHTML = `
                        <div class="price-row" style="justify-content:space-between;">
                            <strong>Plan #${idx + 1}</strong>
                            <button class="btn btn-sm" style="color:red;" onclick="delPrice('${cat}',${idx})">ÂâäÈô§</button>
                        </div>
                        <input class="pf-input price-input-lg" value="${plan.title || ''}" placeholder="„Éó„É©„É≥Âêç" onchange="updPrice('${cat}',${idx},'title',this.value)">
                        <textarea class="pf-input" rows="3" placeholder="Ë™¨Êòé" onchange="updPrice('${cat}',${idx},'desc',this.value)">${plan.desc || ''}</textarea>
                        <div class="price-row">
                            <input class="pf-input" placeholder="‰æ°Ê†º" value="${plan.price || ''}" onchange="updPrice('${cat}',${idx},'price',this.value)">
                            <input class="pf-input" placeholder="Á¥çÊúü" value="${plan.period || ''}" onchange="updPrice('${cat}',${idx},'period',this.value)">
                            <input class="pf-input" placeholder="‰øÆÊ≠£ÂõûÊï∞" value="${plan.revisions || ''}" onchange="updPrice('${cat}',${idx},'revisions',this.value)">
                        </div>
                     `;
                    container.appendChild(div);
                });
                const addBtn = document.createElement('button');
                addBtn.className = 'btn';
                addBtn.innerText = '+ ' + cat + ' „Éó„É©„É≥ËøΩÂä†';
                addBtn.style.marginTop = "10px";
                addBtn.onclick = () => { DATA.prices[cat].push({ title: 'New Plan' }); renderPrices(); };
                container.appendChild(addBtn);
            });
        }
        function updPrice(cat, idx, k, v) { DATA.prices[cat][idx][k] = v; }
        function delPrice(cat, idx) { DATA.prices[cat].splice(idx, 1); renderPrices(); }
        async function savePrices() {
            await postAPI('update_prices', DATA.prices);
            alert("Saved Prices");
        }

        checkAuth();
    </script>
</body>

</html>