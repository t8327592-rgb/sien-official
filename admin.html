<!DOCTYPE html>
<html lang="ja">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Dashboard | Sien-Official</title>
    <!-- Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link
        href="https://fonts.googleapis.com/css2?family=Jost:wght@400;500;600&family=Noto+Sans+JP:wght@400;500;700&display=swap"
        rel="stylesheet">
    <!-- Icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <!-- Favicon -->
    <link rel="icon" href="./assets/favicon.ico">

    <style>
        :root {
            /* Design Consistency */
            --primary: #4285f4;
            /* Site common blue */
            --bg-color: #f3f4f6;
            --text-main: #333;
            --text-muted: #666;
            --border-color: #e5e7eb;
            --white: #ffffff;
            --shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);

            --status-gray: #9ca3af;
            --status-orange: #f97316;
            --status-green: #10b981;
            --status-red: #ef4444;
            /* Light red/Archive */

            --font-heading: 'Jost', sans-serif;
            --font-body: 'Noto Sans JP', sans-serif;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            background-color: var(--bg-color);
            color: var(--text-main);
            font-family: var(--font-body);
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            -webkit-font-smoothing: antialiased;
        }

        h1,
        h2,
        h3,
        h4,
        h5 {
            font-family: var(--font-heading);
            font-weight: 500;
        }

        /* HEADER & TABS INTEGRATION */
        .admin-header {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            height: 70px;
            display: flex;
            align-items: center;
            padding: 0 40px;
            border-bottom: 1px solid var(--border-color);
            position: sticky;
            top: 0;
            z-index: 100;
            gap: 40px;
        }

        .brand {
            font-weight: 700;
            font-size: 1.4rem;
            letter-spacing: 0.02em;
            color: var(--text-main);
            text-decoration: none;
            font-family: var(--font-heading);
            margin-right: auto;
        }

        .brand img {
            height: 28px;
            vertical-align: middle;
        }

        .nav-tabs {
            display: flex;
            gap: 10px;
            flex: 1;
            justify-content: center;
        }

        .nav-tab {
            padding: 10px 15px;
            font-size: 0.95rem;
            color: var(--text-muted);
            cursor: pointer;
            position: relative;
            transition: color 0.2s;
            font-family: var(--font-heading);
            font-weight: 500;
        }

        .nav-tab:hover {
            color: var(--primary);
        }

        .nav-tab.active {
            color: var(--primary);
            font-weight: 600;
        }

        .nav-tab.active::after {
            content: '';
            position: absolute;
            bottom: -23px;
            left: 0;
            width: 100%;
            height: 3px;
            background: var(--primary);
        }

        .user-menu {
            margin-left: auto;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        /* MAIN */
        .main-container {
            flex: 1;
            padding: 40px;
            max-width: 1200px;
            margin: 0 auto;
            width: 100%;
        }

        .breadcrumb {
            font-size: 0.85rem;
            color: var(--primary);
            margin-bottom: 20px;
            font-weight: 500;
        }

        .breadcrumb span {
            color: var(--text-muted);
        }

        .page-header {
            display: flex;
            align-items: center;
            gap: 15px;
            margin-bottom: 30px;
            justify-content: space-between;
        }

        .page-title {
            font-size: 1.5rem;
            font-weight: 600;
            letter-spacing: -0.02em;
        }

        .content-card {
            background: var(--white);
            border-radius: 12px;
            padding: 30px;
            box-shadow: var(--shadow);
            min-height: 600px;
            border: 1px solid var(--border-color);
        }

        .tab-pane {
            display: none;
        }

        .tab-pane.active {
            display: block;
            animation: fadeIn 0.3s ease;
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(5px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        /* FILTER & SEARCH */
        .filter-section {
            display: flex;
            flex-direction: column;
            gap: 20px;
            margin-bottom: 30px;
            border-bottom: 1px solid var(--border-color);
            padding-bottom: 20px;
        }

        .search-row {
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .search-input-group {
            display: flex;
            border: 1px solid var(--border-color);
            border-radius: 8px;
            overflow: hidden;
            width: 320px;
            transition: 0.2s;
        }

        .search-input-group:focus-within {
            border-color: var(--primary);
            ring: 2px solid var(--primary);
        }

        .search-prefix {
            background: var(--primary);
            color: white;
            padding: 10px 14px;
            font-size: 0.9rem;
            font-weight: 600;
            white-space: nowrap;
        }

        .search-input {
            border: none;
            padding: 10px 14px;
            outline: none;
            width: 100%;
            font-size: 0.9rem;
            color: var(--text-main);
        }

        /* STATUS TABS */
        .status-tabs {
            display: flex;
            gap: 24px;
            font-size: 0.9rem;
            color: var(--text-muted);
            margin-top: 10px;
            overflow-x: auto;
            padding-bottom: 5px;
        }

        .status-tab {
            cursor: pointer;
            position: relative;
            padding-bottom: 8px;
            white-space: nowrap;
        }

        .status-tab:hover {
            color: var(--primary);
        }

        .status-tab.active {
            color: var(--primary);
            font-weight: 600;
            border-bottom: 2px solid var(--primary);
        }

        .count-badge {
            margin-left: 6px;
            font-size: 0.8em;
            color: var(--text-light);
            background: #f3f4f6;
            padding: 2px 6px;
            border-radius: 4px;
        }

        /* TABLE */
        .admin-table {
            width: 100%;
            border-collapse: separate;
            border-spacing: 0;
            font-size: 0.9rem;
        }

        .admin-table th {
            text-align: left;
            padding: 16px 12px;
            font-weight: 600;
            color: var(--text-muted);
            border-bottom: 1px solid var(--border-color);
            white-space: nowrap;
            font-family: var(--font-heading);
            letter-spacing: 0.03em;
        }

        .admin-table td {
            padding: 20px 12px;
            border-bottom: 1px solid #f9fafb;
            vertical-align: middle;
        }

        .admin-table tr:hover td {
            background: #f9fafb;
        }

        .client-name {
            font-weight: 600;
            color: var(--primary);
            cursor: pointer;
            text-decoration: underline;
        }

        .plan-name {
            font-size: 0.85rem;
            color: var(--text-muted);
        }

        /* STATUS SELECT */
        .status-select {
            padding: 6px 10px;
            border-radius: 6px;
            font-size: 0.85rem;
            border: 1px solid var(--border-color);
            cursor: pointer;
            font-weight: 600;
        }

        /* Dynamic Status Colors via JS logic mainly, or classes if fixed */

        .btn-restore {
            background: transparent;
            border: 1px solid var(--text-light);
            color: var(--text-muted);
            padding: 4px 10px;
            border-radius: 4px;
            font-size: 0.8rem;
            cursor: pointer;
        }

        .btn-restore:hover {
            border-color: var(--primary);
            color: var(--primary);
        }

        /* PF GRID */
        .pf-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
            gap: 25px;
        }

        .pf-item {
            border: 1px solid var(--border-color);
            border-radius: 12px;
            overflow: hidden;
            background: #fff;
            transition: 0.2s;
            position: relative;
        }

        .pf-item:hover {
            box-shadow: var(--shadow);
            transform: translateY(-2px);
        }

        .pf-thumb {
            height: 180px;
            background: #000;
            position: relative;
        }

        .pf-thumb img {
            width: 100%;
            height: 100%;
            object-fit: cover;
            opacity: 0.8;
        }

        .pf-inputs {
            padding: 16px;
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        /* PRICE INPUTS WITH UNITS */
        .price-section-divider {
            border-top: 4px solid #eff6ff;
            margin: 40px 0;
            padding-top: 40px;
        }

        .price-header {
            border-left: 4px solid var(--primary);
            padding-left: 15px;
            margin-bottom: 20px;
            font-size: 1.2rem;
            font-weight: 700;
            color: var(--text-main);
        }

        .price-group {
            border: 1px solid var(--border-color);
            padding: 20px;
            border-radius: 8px;
            margin-bottom: 20px;
            background: #fff;
        }

        .input-with-unit {
            position: relative;
            display: flex;
            align-items: center;
            width: 100%;
        }

        .input-with-unit input {
            padding-right: 40px;
            width: 100%;
        }

        .input-unit {
            position: absolute;
            right: 10px;
            color: var(--text-muted);
            font-size: 0.85rem;
            pointer-events: none;
        }

        .pf-input {
            width: 100%;
            padding: 10px;
            border: 1px solid var(--border-color);
            border-radius: 6px;
            font-size: 0.9rem;
            transition: 0.2s;
        }

        .pf-input:focus {
            border-color: var(--primary);
            outline: none;
        }

        /* VOICES */
        .voice-card {
            background: #f9fafb;
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 15px;
            border: 1px solid #eee;
        }

        /* FOOTER */
        .admin-footer {
            background: var(--bg-color);
            color: var(--text-muted);
            padding: 20px 0;
            margin-top: auto;
            font-size: 0.8rem;
            text-align: center;
            border-top: 1px solid #eee;
        }

        /* BUTTONS */
        .btn {
            padding: 10px 20px;
            border-radius: 8px;
            border: none;
            cursor: pointer;
            font-size: 0.95rem;
            font-weight: 600;
            transition: all 0.2s;
            font-family: var(--font-heading);
            display: inline-flex;
            align-items: center;
            gap: 8px;
            justify-content: center;
        }

        .btn-primary {
            background: var(--primary);
            color: white;
            box-shadow: 0 4px 6px rgba(66, 133, 244, 0.2);
        }

        .btn-primary:hover {
            transform: translateY(-1px);
            box-shadow: 0 6px 12px rgba(66, 133, 244, 0.3);
        }

        .btn-ghost {
            background: transparent;
            color: var(--text-muted);
        }

        .btn-ghost:hover {
            background: #eee;
        }

        .btn-sm {
            padding: 5px 10px;
            font-size: 0.8rem;
        }

        /* TOAST */
        #toast {
            position: fixed;
            bottom: 30px;
            right: 30px;
            background: #333;
            color: white;
            padding: 15px 25px;
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
            font-weight: 500;
            transform: translateY(100px);
            opacity: 0;
            transition: all 0.3s cubic-bezier(0.68, -0.55, 0.27, 1.55);
            z-index: 1000;
        }

        #toast.show {
            transform: translateY(0);
            opacity: 1;
        }

        /* Detail View */
        .detail-view {
            display: none;
        }

        .detail-view.active {
            display: block;
            animation: fadeIn 0.3s;
        }

        .detail-label {
            color: #666;
            font-size: 0.8rem;
            display: block;
            margin-bottom: 4px;
        }

        .detail-val {
            font-weight: 600;
            color: #333;
            word-break: break-all;
        }
    </style>
</head>

<body>
    <!-- AUTH -->
    <div id="auth-screen"
        style="position:fixed; top:0; left:0; width:100%; height:100%; background:#f3f4f6; z-index:9999; display:flex; align-items:center; justify-content:center;">
        <div
            style="background:white; padding:40px; border-radius:8px; width:350px; text-align:center; box-shadow:0 10px 25px rgba(0,0,0,0.05);">
            <h2 style="font-weight:700; margin-bottom:20px;">Sien-Official</h2>
            <input type="password" id="auth-pass" placeholder="Password"
                style="width:100%; padding:10px; margin-bottom:15px; border:1px solid #ddd; border-radius:4px;">
            <button onclick="login()" class="btn btn-primary" style="width:100%;">Login</button>
        </div>
    </div>

    <header class="admin-header">
        <a href="#" class="brand">
            <img src="./assets/logo.png" alt="Logo">
        </a>

        <nav class="nav-tabs">
            <div class="nav-tab active" onclick="switchTab('orders', this)">依頼管理</div>
            <div class="nav-tab" onclick="switchTab('portfolio', this)">ポートフォリオ</div>
            <div class="nav-tab" onclick="switchTab('voices', this)">お客様の声</div>
            <div class="nav-tab" onclick="switchTab('prices', this)">プラン・料金設定</div>
            <div class="nav-tab" onclick="switchTab('account', this)">アカウント設定</div>
        </nav>

        <div class="user-menu">
            <button onclick="logout()" class="btn btn-sm"
                style="background:#fff; border:1px solid #ddd;">Logout</button>
        </div>
    </header>

    <main class="main-container">
        <!-- Toast Notification -->
        <div id="toast"><i class="fa-solid fa-check-circle"></i> 保存しました</div>

        <div class="breadcrumb">
            Admin Page > <span id="page-crumb">依頼管理</span>
        </div>

        <section class="content-card">
            <!-- ORDERS TAB -->
            <div id="tab-orders" class="tab-pane active">
                <div class="page-header">
                    <div class="page-title">依頼管理</div>
                </div>

                <div class="filter-section">
                    <div class="search-row">
                        <div class="search-input-group">
                            <div class="search-prefix"><i class="fa-solid fa-search"></i></div>
                            <input type="text" class="search-input" placeholder="依頼者名、曲名で検索..."
                                onkeyup="renderOrders(this.value)">
                        </div>
                    </div>
                    <div class="status-tabs">
                        <div class="status-tab active" onclick="setFilter('all', this)">全て(<span id="cnt-all">0</span>)
                        </div>
                        <div class="status-tab" onclick="setFilter('未着手', this)">未着手(<span id="cnt-new">0</span>)</div>
                        <div class="status-tab" onclick="setFilter('支払い待ち', this)">支払い待ち(<span id="cnt-pay">0</span>)
                        </div>
                        <div class="status-tab" onclick="setFilter('全て入金済み', this)">入金済み(<span id="cnt-paid">0</span>)
                        </div>
                        <div class="status-tab" onclick="setFilter('納品済み', this)">納品済み(<span id="cnt-done">0</span>)
                        </div>
                        <div class="status-tab" onclick="setFilter('取引終了', this)">取引終了(<span id="cnt-closed">0</span>)
                        </div>
                        <div class="status-tab" onclick="setFilter('archive', this)">キャンセル(<span
                                id="cnt-cancel">0</span>)</div>
                    </div>
                </div>

                <table class="admin-table">
                    <thead>
                        <tr>
                            <th>ご依頼日</th>
                            <th>曲名</th>
                            <th>ご依頼者名</th>
                            <th>プラン</th>
                            <th>納期</th>
                            <th>ステータス</th>
                            <th>操作</th>
                        </tr>
                    </thead>
                    <tbody id="order-tbody"></tbody>
                </table>
            </div>

            <!-- ORDER DETAIL -->
            <div id="tab-order-detail" class="tab-pane">
                <div class="page-header">
                    <button class="btn btn-sm" onclick="closeDetail()"
                        style="margin-right:15px; background:#eff6ff; color:var(--primary);">&larr; 一覧に戻る</button>
                    <div class="page-title">案件詳細</div>
                </div>
                <div id="detail-content" style="max-width:900px; margin:0 auto;"></div>
            </div>

            <!-- PORTFOLIO TAB -->
            <div id="tab-portfolio" class="tab-pane">
                <div class="page-header">
                    <div class="page-title">ポートフォリオ管理</div>
                    <button class="btn btn-primary" onclick="savePf()">変更を保存する</button>
                </div>
                <div class="mb-4" style="margin-bottom:20px;">
                    <select id="pf-cat-select" onchange="renderPf()"
                        style="padding:10px; border-radius:6px; border:1px solid #ddd; margin-right:10px;">
                        <option value="works">制作実績 (Works)</option>
                        <option value="mix">ミックス (Mix)</option>
                        <option value="orig">オリジナル (Original)</option>
                    </select>
                    <button class="btn btn-ghost" style="border:1px dashed #ccc;" onclick="addPf()">+ 動画を追加</button>
                </div>
                <div id="pf-container" class="pf-grid"></div>
            </div>

            <!-- VOICES TAB -->
            <div id="tab-voices" class="tab-pane">
                <div class="page-header">
                    <div class="page-title">お客様の声 管理</div>
                    <button class="btn btn-primary" onclick="saveVoices()">変更を保存する</button>
                </div>
                <button class="btn btn-ghost" style="border:1px dashed #ccc; margin-bottom:20px;" onclick="addVoice()">+
                    声を追加</button>
                <div id="voice-container"></div>
            </div>

            <!-- PRICES TAB -->
            <div id="tab-prices" class="tab-pane">
                <div class="page-header">
                    <div class="page-title">プラン・料金設定</div>
                    <button class="btn btn-primary" onclick="savePrices()">変更を保存する</button>
                </div>

                <div id="price-mix-area"></div>
                <div style="text-align:center; margin-bottom: 40px;">
                    <button class="btn btn-ghost" style="border:1px dashed #ccc;" onclick="addPlan('mix')">+
                        ミックスプランを追加</button>
                </div>

                <div class="price-section-divider"></div>

                <div id="price-orig-area"></div>
                <div style="text-align:center;">
                    <button class="btn btn-ghost" style="border:1px dashed #ccc;" onclick="addPlan('orig')">+
                        オリジナルプランを追加</button>
                </div>
            </div>

            <div id="tab-account" class="tab-pane">
                <div class="page-header">
                    <div class="page-title">アカウント設定</div>
                </div>

                <div class="content-card" style="min-height:auto; margin-bottom:30px;">
                    <h3>管理者情報</h3>
                    <p style="margin-top:10px; color:#666;">現在のパスワードでログイン中です。</p>
                </div>

                <div class="content-card" style="min-height:auto; border-color:var(--status-red); background:#fef2f2;">
                    <h3 style="color:var(--status-red);">Danger Zone</h3>
                    <p style="margin-top:10px; margin-bottom:20px; color:#b91c1c;">
                        すべての依頼データ（アーカイブ含む）を完全に削除します。<br>
                        この操作は取り消せません。
                    </p>
                    <button class="btn" style="background:var(--status-red); color:white;"
                        onclick="resetAllData()">依頼データをすべて削除する</button>
                </div>
            </div>
        </section>
    </main>

    <footer class="admin-footer">
        Copyright (c) 2026 Sien-Official. All Rights Reserved.
    </footer>

    <script>
        let TOKEN = localStorage.getItem('admin_token') || '';
        let DATA = { orders: [], works: [], mix: [], orig: [], prices: { mix: [], orig: [] }, voices: [] };
        let activePfCat = 'works';

        async function resetAllData() {
            if (!confirm("本当に全ての依頼データを削除しますか？\nこの操作は取り消せません。")) return;
            if (!confirm("最終確認：本当に削除してよろしいですか？")) return;

            try {
                await postAPI('reset_all', {});
                alert("全てのデータを削除しました。");
                location.reload();
            } catch (e) {
                alert("削除に失敗しました");
                console.error(e);
            }
        }

        function showToast(msg) {
            const t = document.getElementById('toast');
            t.innerHTML = `<i class="fa-solid fa-check-circle"></i> ${msg}`;
            t.classList.add('show');
            setTimeout(() => t.classList.remove('show'), 3000);
        }

        function checkAuth() {
            if (TOKEN) {
                document.getElementById('auth-screen').style.display = 'none';
                fetchData();
            }
        }
        async function login() {
            const pass = document.getElementById('auth-pass').value;
            try {
                const res = await fetch('/api/admin', { headers: { 'x-admin-password': pass } });
                if (res.ok) {
                    TOKEN = pass;
                    localStorage.setItem('admin_token', pass);
                    checkAuth();
                } else alert("Invalid Password");
            } catch (e) { alert("Error"); }
        }
        function logout() { localStorage.removeItem('admin_token'); location.reload(); }

        async function fetchData() {
            try {
                const res = await fetch('/api/admin', { headers: { 'x-admin-password': TOKEN } });
                if (res.status === 401) { logout(); return; }
                const json = await res.json();
                DATA = { ...DATA, ...json };

                // --- DEDUPLICATION LOGIC ---
                if (Array.isArray(DATA.orders)) {
                    const uniqueOrders = new Map();
                    // Prefer keeping later ones if ID matches? Or just first. Data is prepended so likely descending.
                    // To be safe, rely on ID.
                    DATA.orders.forEach(o => uniqueOrders.set(o.id, o));
                    DATA.orders = Array.from(uniqueOrders.values());
                }
                if (Array.isArray(DATA.archive)) {
                    const uniqueArchive = new Map();
                    DATA.archive.forEach(o => uniqueArchive.set(o.id, o));
                    DATA.archive = Array.from(uniqueArchive.values());
                }

                if (Array.isArray(DATA.prices)) DATA.prices = { mix: [], orig: [] };
                if (!DATA.prices.mix) DATA.prices.mix = [];
                if (!DATA.prices.orig) DATA.prices.orig = [];
                if (!DATA.archive) DATA.archive = [];
                if (!DATA.voices) DATA.voices = [];

                renderOrders();
                renderPf();
                renderPrices();
                renderVoices();
            } catch (e) { console.error(e); }
        }

        async function postAPI(action, data) {
            await fetch('/api/admin', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json', 'x-admin-password': TOKEN },
                body: JSON.stringify({ action, data })
            });
        }

        function switchTab(tabId, el) {
            document.querySelectorAll('.tab-pane').forEach(d => d.classList.remove('active'));
            document.getElementById('tab-' + tabId).classList.add('active');

            document.querySelectorAll('.nav-tab').forEach(t => t.classList.remove('active'));
            el.classList.add('active');

            const map = { 'orders': '依頼管理', 'portfolio': 'ポートフォリオ', 'prices': 'プラン設定', 'account': 'アカウント', 'voices': 'お客様の声' };
            document.getElementById('page-crumb').innerText = map[tabId];
        }

        // --- HELPER: Plan Name Localization ---
        function formatPlanName(plan) {
            if (!plan) return '-';
            const p = plan.trim();
            if (p.toLowerCase().includes('mix') || p === 'Mix Plan') return 'ミックス／マスタリング';
            if (p.toLowerCase().includes('original') || p === 'Original Plan' || p === 'original_std') return 'オリジナル楽曲制作';

            // Map form values to nice names
            const formMap = {
                'standard': 'スタンダードプラン',
                'one_chorus': 'ワンコーラスプラン',
                'short': 'ショート動画用MIX',
                'speed': 'スピードプラン',
                'super_speed': '超スピードプラン',
                'collab': 'コラボ・合唱プラン',
                'original_std': 'オリジナル楽曲 スタンダード',
                'original_lyrics': 'オリジナル楽曲 作詞持ち込み',
                'other': 'その他・ご相談'
            };
            return formMap[p] || p;
        }

        // --- ORDERS LOGIC ---
        let filterStatus = 'all';

        function setFilter(stat, el) {
            filterStatus = stat;
            document.querySelectorAll('.status-tab').forEach(t => t.classList.remove('active'));
            el.classList.add('active');
            renderOrders();
        }

        function renderOrders(query = '') {
            const tbody = document.getElementById('order-tbody');
            tbody.innerHTML = '';

            let list = [];
            let isArchive = (filterStatus === 'archive' || filterStatus === 'cancel');

            if (isArchive) {
                const archived = DATA.archive || [];
                const cancelled = (DATA.orders || []).filter(o => o.status === 'キャンセル');
                list = [...archived, ...cancelled];
            } else {
                list = DATA.orders || [];
                if (filterStatus !== 'all') {
                    list = list.filter(o => o.status === filterStatus);
                } else {
                    list = list.filter(o => o.status !== 'キャンセル' && o.status !== 'archived');
                }
            }

            // Dedupe again for render
            const uniqueList = new Map();
            list.forEach(o => uniqueList.set(o.id, o));
            list = Array.from(uniqueList.values());
            list.sort((a, b) => new Date(b.date) - new Date(a.date));

            if (query) {
                list = list.filter(o => (o['ご依頼者名'] || '').includes(query) || (o['曲名'] || '').includes(query));
            }

            // Sync counts exactly
            const allOrdersMap = new Map();
            (DATA.orders || []).forEach(o => allOrdersMap.set(o.id, o));
            const uniqueOrders = Array.from(allOrdersMap.values());

            const counts = { 'archive': (DATA.archive || []).length };
            uniqueOrders.forEach(o => counts[o.status] = (counts[o.status] || 0) + 1);

            const countIds = {
                '未着手': 'cnt-new', '支払い待ち': 'cnt-pay', '全て入金済み': 'cnt-paid',
                '納品済み': 'cnt-done', '取引終了': 'cnt-closed', 'キャンセル': 'cnt-cancel'
            };
            Object.keys(countIds).forEach(k => {
                const el = document.getElementById(countIds[k]);
                if (el) {
                    if (k === 'キャンセル') el.innerText = (counts['キャンセル'] || 0) + counts['archive'];
                    else el.innerText = counts[k] || 0;
                }
            });
            document.getElementById('cnt-all').innerText = uniqueOrders.length;


            list.forEach(order => {
                const realIndex = (DATA.orders || []).findIndex(o => o.id === order.id);
                const archiveIndex = (DATA.archive || []).findIndex(a => a.id === order.id);
                const isItemArchived = Boolean(DATA.archive && DATA.archive.find(a => a.id === order.id));

                // Color Logic
                let statusColor = '#333';
                let bg = '#eee';
                if (order.status === '未着手') { statusColor = 'var(--status-gray)'; bg = '#f3f4f6'; }
                if (order.status === '支払い待ち') { statusColor = 'var(--status-orange)'; bg = '#fff7ed'; }
                if (order.status === '全て入金済み') { statusColor = 'var(--status-green)'; bg = '#ecfdf5'; }
                if (order.status === 'アーカイブ' || order.status === 'キャンセル') { statusColor = 'var(--status-red)'; bg = '#fef2f2'; }

                const tr = document.createElement('tr');
                tr.innerHTML = `
                    <td>${new Date(order.date).toLocaleDateString('ja-JP')}</td>
                    <td class="client-name" onclick="showDetail('${order.id}')">${order['曲名'] || 'なし'}</td>
                    <td>${order['ご依頼者名']}</td>
                    <td class="plan-name">${formatPlanName(order['プラン'])}</td>
                    <td>
                        <div class="input-with-unit" style="width:140px;">
                            <input type="date" value="${order.deadline || ''}" 
                                style="border:none; background:transparent; font-family:inherit; cursor:pointer;"
                                onchange="updateDeadline('${order.id}', this.value)">
                        </div>
                    </td>
                    <td>
                         <select onchange="updateStatus('${order.id}', this.value)" class="status-select" style="color:${statusColor}; background:${bg}; border-color:${statusColor};">
                              ${['未着手', '支払い待ち', '全て入金済み', '納品済み', '取引終了', 'キャンセル'].map(s =>
                    `<option value="${s}" ${order.status === s ? 'selected' : ''}>${s}</option>`
                ).join('')}
                           </select>
                    </td>
                    <td style="text-align:right;">
                        ${isItemArchived ?
                        `<button class="btn-restore" onclick="restoreOrder(${archiveIndex}, '${order.id}')">復元</button>` :
                        `<button class="btn-restore" onclick="archiveOrder(${realIndex}, '${order.id}')">Archive</button>`
                    }
                    </td>
                `;
                tbody.appendChild(tr);
            });
        }

        function showDetail(id) {
            const order = [...(DATA.orders || []), ...(DATA.archive || [])].find(o => o.id === id);
            if (!order) return;
            document.getElementById('tab-orders').classList.remove('active');
            document.getElementById('tab-order-detail').classList.add('active');

            const content = document.getElementById('detail-content');

            // Map values for better display
            const paymentMap = { 'bank_transfer': '銀行振込', 'credit_card': 'クレジットカード' };
            const paymentMethod = paymentMap[order['お支払い方法']] || order['お支払い方法'] || '-';

            const contactMethod = (order['希望する連絡手段'] === 'twitter_dm') ? 'Twitter DM' :
                (order['希望する連絡手段'] === 'email') ? 'メール' : order['希望する連絡手段'];

            content.innerHTML = `
                <div style="background:#f9fafb; padding:25px; border-radius:12px; margin-bottom:20px;">
                    <div style="display:flex; justify-content:space-between; align-items:start;">
                         <h3 style="font-size:1.5rem; margin-bottom:5px;">${order['曲名'] || 'なし'}</h3>
                         <div style="text-align:right;">
                            <span class="status-badge" style="background:#fff; border:1px solid #ddd; padding:2px 8px; border-radius:4px;">${order.status}</span>
                            <div style="font-size:0.8rem; color:#888; margin-top:5px;">ID: ${order.id}</div>
                         </div>
                    </div>
                    
                    <hr style="border:0; border-top:1px solid #ddd; margin:15px 0;">
                    
                    <div style="display:grid; grid-template-columns: 1fr 1fr; gap:25px; font-size:0.95rem;">
                        <div>
                            <span class="detail-label">ご依頼者名</span>
                            <div class="detail-val">${order['ご依頼者名']}</div>
                        </div>
                        <div>
                            <span class="detail-label">メールアドレス</span>
                            <div class="detail-val"><a href="mailto:${order['メールアドレス']}" style="color:var(--primary);">${order['メールアドレス']}</a></div>
                        </div>
                        <div>
                            <span class="detail-label">Twitter ID</span>
                            <div class="detail-val">
                                ${order['TwitterID(任意)'] ? `<a href="https://twitter.com/${order['TwitterID(任意)'].replace('@', '')}" target="_blank" style="color:var(--primary);">${order['TwitterID(任意)']}</a>` : '-'}
                            </div>
                        </div>
                        <div>
                             <span class="detail-label">希望する連絡手段</span>
                             <div class="detail-val">${contactMethod}</div>
                        </div>
                        <div>
                            <span class="detail-label">プラン</span>
                            <div class="detail-val">${formatPlanName(order['プラン'])}</div>
                        </div>
                         <div>
                            <span class="detail-label">歌唱キー</span>
                            <div class="detail-val">${order['キー変更'] || '-'}</div>
                        </div>
                         <div>
                            <span class="detail-label">オプション</span>
                            <div class="detail-val">${order['オプション'] || 'なし'}</div>
                        </div>
                         <div>
                            <span class="detail-label">お支払い方法</span>
                            <div class="detail-val">${paymentMethod}</div>
                        </div>
                        <div>
                            <span class="detail-label">ご依頼日</span>
                            <div class="detail-val">${new Date(order.date).toLocaleDateString('ja-JP')} ${new Date(order.date).toLocaleTimeString('ja-JP')}</div>
                        </div>
                        <div>
                            <span class="detail-label">納期</span>
                            <div class="detail-val">${order.deadline || '未設定'}</div>
                        </div>
                    </div>
                </div>
                
                <h4 style="margin-bottom:10px; font-size:1.1rem;">支払いリンク設定</h4>
                 <div style="background:white; border:1px solid #eee; padding:15px; border-radius:8px; margin-bottom:20px;">
                    <input value="${order.paymentLink || ''}" placeholder="Stripeなど支払いリンクを入力 (例: https://buy.stripe.com/...)" 
                    onchange="promptPayLink('${order.id}', this.value)" style="padding:10px; border:1px solid #ccc; border-radius:4px; width:100%; font-family:monospace;">
                    <div style="font-size:0.8rem; color:#666; margin-top:5px;">※ここに入力すると、お客様への案内メール等に使用できます（機能実装予定）</div>
                </div>

                <h4 style="margin-bottom:10px; font-size:1.1rem;">ご依頼内容・資料</h4>
                <div style="background:white; border:1px solid #eee; padding:25px; border-radius:12px;">
                     
                     <div style="margin-bottom:25px;">
                        <span class="detail-label">ご要望・ご質問・特記事項など</span>
                        <div style="white-space:pre-wrap; color:#333; line-height:1.6; background:#f9f9f9; padding:15px; border-radius:6px; border:1px solid #eee;">${order['ご要望・ご質問・特記事項など'] || 'なし'}</div>
                     </div>
                     
                     <div style="display:grid; grid-template-columns: 1fr 1fr; gap:20px;">
                         <div>
                            <span class="detail-label">参考曲 / URL</span>
                            <div style="margin-top:5px; padding:10px; background:#f0f9ff; color:#0369a1; border-radius:6px; border:1px solid #bae6fd;">
                                <i class="fa-solid fa-link"></i> ${order['参考URL(任意)'] ? `<a href="${order['参考URL(任意)']}" target="_blank" style="text-decoration:underline;">${order['参考URL(任意)']}</a>` : 'なし'}
                            </div>
                         </div>
                         <div>
                             <span class="detail-label">レコーディング済み音源 (GigaFile等)</span>
                             <div style="margin-top:5px; padding:10px; background:#f0fdf4; color:#15803d; border-radius:6px; border:1px solid #bbf7d0;">
                                <i class="fa-solid fa-file-audio"></i> ${order['レコーディング済み音源'] ? `<a href="${order['レコーディング済み音源']}" target="_blank" style="text-decoration:underline;">${order['レコーディング済み音源']}</a>` : 'なし'}
                             </div>
                        </div>
                     </div>
                </div>
            `;
        }

        function closeDetail() {
            document.getElementById('tab-order-detail').classList.remove('active');
            document.getElementById('tab-orders').classList.add('active');
            renderOrders();
        }

        async function promptPayLink(id, val = null) {
            let link = val;
            if (link === null) {
                const order = [...(DATA.orders || []), ...(DATA.archive || [])].find(o => o.id === id);
                if (!order) return;
                link = prompt("支払いリンクを入力:", order.paymentLink || "");
            }
            if (link !== null) {
                await postAPI('update_order_status', { orderId: id, updates: { paymentLink: link } });
                const order = [...(DATA.orders || []), ...(DATA.archive || [])].find(o => o.id === id);
                if (order) order.paymentLink = link;
                if (document.getElementById('tab-orders').classList.contains('active')) renderOrders();
            }
        }

        async function updateStatus(id, status) {
            await postAPI('update_order_status', { orderId: id, status: status });
            const order = DATA.orders.find(o => o.id === id);
            if (order) order.status = status;
            renderOrders();
        }
        async function updateDeadline(id, date) {
            await postAPI('update_order_status', { orderId: id, deadline: date });
            const order = DATA.orders.find(o => o.id === id);
            if (order) order.deadline = date;
        }
        async function archiveOrder(idx, id) {
            if (!confirm("この依頼をアーカイブしますか？")) return;
            if (idx === -1) idx = DATA.orders.findIndex(o => o.id === id);
            if (idx === -1) return;
            const item = DATA.orders.splice(idx, 1)[0];
            item.status = 'archived';
            DATA.archive.unshift(item);
            renderOrders();
            await postAPI('archive_order', { index: idx });
        }
        async function restoreOrder(idx, id) {
            if (!confirm("復元しますか？")) return;
            if (idx === -1) idx = DATA.archive.findIndex(o => o.id === id);
            if (idx === -1) return;
            const item = DATA.archive.splice(idx, 1)[0];
            item.status = '未着手';
            DATA.orders.unshift(item);
            renderOrders();
            await postAPI('restore_order', { index: idx });
        }

        // --- PORTFOLIO ---
        function renderPf() {
            activePfCat = document.getElementById('pf-cat-select').value;
            const list = DATA[activePfCat] || [];
            const container = document.getElementById('pf-container');
            container.innerHTML = '';

            list.forEach((item, idx) => {
                const div = document.createElement('div');
                div.className = 'pf-item';
                // Try to get thumbnail from ID
                const thumbUrl = `https://img.youtube.com/vi/${item.id}/mqdefault.jpg`;

                div.innerHTML = `
                    <div class="pf-thumb">
                        ${item.id ? `<img src="${thumbUrl}" alt="Thumb">` : '<div style="background:#eee; width:100%; height:100%;"></div>'}
                    </div>
                    <div class="pf-inputs">
                        <input class="pf-input" placeholder="YouTube ID" value="${item.id || ''}" onchange="updatePf(${idx}, 'id', this.value)">
                        <input class="pf-input" placeholder="Title" value="${item.title || ''}" onchange="updatePf(${idx}, 'title', this.value)">
                         <button class="btn btn-sm" style="background:#fee; color:red;" onclick="delPf(${idx})">削除</button>
                    </div>
                `;
                container.appendChild(div);
            });
        }
        function updatePf(idx, k, v) {
            if (k === 'id') {
                const reg = /^.*(youtu.be\/|v\/|u\/\w\/|embed\/|watch\?v=|\&v=)([^#\&\?]*).*/;
                const m = v.match(reg);
                if (m && m[2].length === 11) v = m[2];
            }
            DATA[activePfCat][idx][k] = v;
            if (k === 'id') renderPf(); // Re-render to show new thumb
        }
        function addPf() { if (!DATA[activePfCat]) DATA[activePfCat] = []; DATA[activePfCat].push({ id: '' }); renderPf(); }
        function delPf(idx) { DATA[activePfCat].splice(idx, 1); renderPf(); }
        async function savePf() {
            await postAPI('update_portfolio', { category: activePfCat, items: DATA[activePfCat] });
            showToast("ポートフォリオを保存しました");
        }

        // --- VOICES (NEW) ---
        function renderVoices() {
            const list = DATA.voices || [];
            const container = document.getElementById('voice-container');
            container.innerHTML = '';

            list.forEach((v, idx) => {
                const div = document.createElement('div');
                div.className = 'voice-card';
                div.innerHTML = `
                    <div style="display:flex; justify-content:space-between; margin-bottom:10px;">
                        <strong>Review #${idx + 1}</strong>
                        <button class="btn btn-sm" style="color:red;" onclick="delVoice(${idx})">削除</button>
                    </div>
                    <div style="display:grid; gap:10px;">
                        <input class="pf-input" placeholder="お客様名" value="${v.name || ''}" onchange="updVoice(${idx}, 'name', this.value)">
                        <input class="pf-input" placeholder="アイコンURL (任意)" value="${v.icon || ''}" onchange="updVoice(${idx}, 'icon', this.value)">
                        <textarea class="pf-input" rows="3" placeholder="感想・コメント" onchange="updVoice(${idx}, 'content', this.value)">${v.content || ''}</textarea>
                    </div>
                `;
                container.appendChild(div);
            });
        }
        function addVoice() { DATA.voices.push({ name: '', content: '' }); renderVoices(); }
        function updVoice(idx, k, v) { DATA.voices[idx][k] = v; }
        function delVoice(idx) { DATA.voices.splice(idx, 1); renderVoices(); }
        async function saveVoices() {
            await postAPI('update_voices', DATA.voices);
            showToast("お客様の声を保存しました");
        }


        // --- PRICES ---
        function renderPrices() {
            renderPriceSection('mix', 'price-mix-area', 'ミックスプラン');
            renderPriceSection('orig', 'price-orig-area', 'オリジナル楽曲制作');
        }

        function renderPriceSection(cat, containerId, title) {
            const container = document.getElementById(containerId);
            container.innerHTML = `<h3 class="price-header">${title}</h3>`;

            const list = DATA.prices[cat] || [];
            list.forEach((plan, idx) => {
                const div = document.createElement('div');
                div.className = 'price-group';
                div.innerHTML = `
                    <div style="display:flex; justify-content:space-between; margin-bottom:15px;">
                        <span style="font-weight:600; color:#555;">Plan #${idx + 1}</span>
                        <button class="btn btn-sm" style="color:red;" onclick="delPrice('${cat}',${idx})">削除</button>
                    </div>
                    <input class="pf-input" style="font-size:1.1rem; font-weight:700; margin-bottom:10px;" value="${plan.title || ''}" placeholder="プラン名" onchange="updPrice('${cat}',${idx},'title',this.value)">
                    <textarea class="pf-input" rows="2" style="margin-bottom:15px;" placeholder="プラン説明" onchange="updPrice('${cat}',${idx},'desc',this.value)">${plan.desc || ''}</textarea>
                    
                    <div style="display:flex; gap:20px;">
                        <div class="input-with-unit">
                             <input class="pf-input" placeholder="価格" value="${plan.price || ''}" 
                                onfocus="this.value = this.value.replace(/[^0-9]/g, '')"
                                onblur="formatPriceInput(this, '${cat}', ${idx})"
                             >
                             <span class="input-unit">円</span>
                        </div>
                        <div class="input-with-unit">
                             <input class="pf-input" placeholder="納期" value="${plan.period || ''}" onchange="updPrice('${cat}',${idx},'period',this.value)">
                             <span class="input-unit">日</span>
                        </div>
                        <div class="input-with-unit">
                             <input class="pf-input" placeholder="修正" value="${plan.revisions || ''}" onchange="updPrice('${cat}',${idx},'revisions',this.value)">
                             <span class="input-unit">回</span>
                        </div>
                    </div>
                `;
                container.appendChild(div);
            });
        }

        function addPlan(cat) { DATA.prices[cat].push({ title: 'New Plan' }); renderPrices(); }

        function formatPriceInput(el, cat, idx) {
            let val = el.value.replace(/[^0-9]/g, '');
            if (!val) return;
            const formatted = parseInt(val).toLocaleString();
            el.value = formatted;
            updPrice(cat, idx, 'price', formatted);
        }

        function updPrice(cat, idx, k, v) { DATA.prices[cat][idx][k] = v; }
        function delPrice(cat, idx) { DATA.prices[cat].splice(idx, 1); renderPrices(); }
        async function savePrices() {
            await postAPI('update_prices', DATA.prices);
            showToast("料金プランを保存しました");
        }

        checkAuth();
    </script>
</body>

</html>