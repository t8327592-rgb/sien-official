<!DOCTYPE html>
<html lang="ja">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Creator Dashboard | Sien-Official</title>
    <link rel="icon" type="image/png" href="./assets/favicon.png">

    <!-- Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link
        href="https://fonts.googleapis.com/css2?family=Jost:wght@300;400;500;600&family=Noto+Sans+JP:wght@300;400;500;700&display=swap"
        rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

    <!-- Global Style -->
    <link rel="stylesheet" href="style.css">

    <style>
        /* --- ADMIN DASHBOARD THEME --- */
        body {
            background-color: var(--bg-gray);
            font-family: var(--font-body);
            color: var(--text-main);
        }

        /* Utils */
        .hidden {
            display: none !important;
        }

        .flex {
            display: flex;
        }

        .items-center {
            align-items: center;
        }

        .justify-between {
            justify-content: space-between;
        }

        .gap-2 {
            gap: 0.5rem;
        }

        .gap-4 {
            gap: 1rem;
        }

        .mt-4 {
            margin-top: 1rem;
        }

        .mb-4 {
            margin-bottom: 1rem;
        }

        .text-sm {
            font-size: 0.875rem;
        }

        .text-gray {
            color: var(--text-muted);
        }

        .font-bold {
            font-weight: 700;
        }

        .w-full {
            width: 100%;
        }

        /* Auth Screen */
        #auth-screen {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100vh;
            background: rgba(255, 255, 255, 0.8);
            backdrop-filter: blur(10px);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1000;
        }

        .auth-card {
            background: white;
            padding: 3rem;
            border-radius: 20px;
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.1);
            width: 100%;
            max-width: 400px;
            text-align: center;
        }

        /* Nav & Headers */
        .admin-header {
            background: white;
            border-bottom: 1px solid var(--border-color);
            padding: 0 24px;
            height: 64px;
            display: flex;
            align-items: center;
            justify-content: space-between;
        }

        .brand {
            font-family: var(--font-heading);
            font-weight: 700;
            font-size: 1.25rem;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .brand span {
            color: var(--accent-blue);
        }

        .user-menu {
            display: flex;
            align-items: center;
            gap: 16px;
        }

        .avatar img {
            width: 32px;
            height: 32px;
            border-radius: 50%;
            object-fit: cover;
        }

        /* NAVIGATION */
        .nav-bar {
            background: white;
            border-bottom: 1px solid var(--border-color);
            padding: 0 24px;
            display: flex;
            gap: 24px;
        }

        .nav-item {
            padding: 16px 0;
            font-size: 0.9rem;
            font-weight: 500;
            color: var(--text-muted);
            cursor: pointer;
            border-bottom: 2px solid transparent;
            transition: 0.2s;
        }

        .nav-item:hover {
            color: var(--accent-blue);
        }

        .nav-item.active {
            color: var(--accent-blue);
            border-bottom-color: var(--accent-blue);
        }

        /* Main Layout */
        .main-content {
            padding: 32px 24px;
            max-width: 1200px;
            margin: 0 auto;
        }

        .page-title {
            font-size: 1.5rem;
            font-weight: 700;
            margin-bottom: 2rem;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        /* FILTER BAR */
        .filter-bar {
            display: flex;
            gap: 5px;
            margin-bottom: 20px;
            flex-wrap: wrap;
            background: white;
            padding: 10px 20px;
            border-radius: 8px;
            border: 1px solid #e5e7eb;
        }

        .filter-chip {
            padding: 6px 14px;
            border-radius: 20px;
            font-size: 0.85rem;
            cursor: pointer;
            color: #6b7280;
            font-weight: 500;
        }

        .filter-chip:hover {
            background: #f3f4f6;
        }

        .filter-chip.active {
            background: #eff6ff;
            color: var(--accent-blue);
            font-weight: 600;
        }

        .search-input {
            margin-left: auto;
            border: 1px solid #e5e7eb;
            padding: 6px 12px;
            border-radius: 6px;
            font-size: 0.9rem;
            width: 250px;
        }

        /* DATA TABLE */
        .data-card {
            background: white;
            border-radius: 12px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.02);
            overflow: hidden;
            border: 1px solid #e5e7eb;
        }

        .data-table {
            width: 100%;
            border-collapse: collapse;
        }

        .data-table th {
            background: #f9fafb;
            padding: 16px 24px;
            text-align: left;
            font-weight: 600;
            font-size: 0.8rem;
            text-transform: uppercase;
            color: #6b7280;
            letter-spacing: 0.05em;
        }

        .data-table td {
            padding: 16px 24px;
            border-top: 1px solid #f3f4f6;
            vertical-align: middle;
            color: #374151;
        }

        .data-table tr:hover {
            background: #f9fafb;
            transition: background 0.1s;
        }

        .user-cell {
            display: flex;
            flex-direction: column;
        }

        .user-name {
            font-weight: 600;
            font-size: 0.95rem;
        }

        .user-sub {
            font-size: 0.8rem;
            color: #9ca3af;
        }

        /* STATUS BADGES */
        .status-badge {
            padding: 4px 10px;
            border-radius: 6px;
            font-size: 0.75rem;
            font-weight: 600;
            display: inline-block;
            white-space: nowrap;
        }

        .bg-gray-100 {
            background: #f3f4f6;
            color: #4b5563;
        }

        .bg-orange-100 {
            background: #fff7ed;
            color: #c2410c;
        }

        .bg-green-100 {
            background: #ecfdf5;
            color: #047857;
        }

        .bg-blue-100 {
            background: #eff6ff;
            color: #1e40af;
        }

        .bg-red-100 {
            background: #fef2f2;
            color: #b91c1c;
        }

        /* PORTFOLIO GRID */
        .pf-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
            gap: 24px;
        }

        .pf-card {
            background: white;
            border-radius: 12px;
            border: 1px solid #e5e7eb;
            overflow: hidden;
            transition: transform 0.2s;
        }

        .pf-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 20px rgba(0, 0, 0, 0.05);
        }

        .pf-thumb {
            aspect-ratio: 16/9;
            background: #111;
            position: relative;
        }

        .pf-thumb iframe {
            width: 100%;
            height: 100%;
            opacity: 0.8;
            pointer-events: none;
        }

        .pf-body {
            padding: 16px;
        }

        .form-label {
            display: block;
            font-size: 0.75rem;
            font-weight: 600;
            color: #6b7280;
            margin-bottom: 4px;
        }

        .form-input {
            width: 100%;
            padding: 8px 10px;
            border: 1px solid #e5e7eb;
            border-radius: 6px;
            font-size: 0.9rem;
            margin-bottom: 12px;
            transition: border 0.2s;
        }

        .form-input:focus {
            outline: none;
            border-color: var(--accent-blue);
            box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
        }

        .action-bar {
            border-top: 1px solid #f3f4f6;
            padding: 10px 16px;
            display: flex;
            justify-content: flex-end;
            background: #f9fafb;
        }

        /* BUTTONS */
        .btn {
            padding: 8px 16px;
            border-radius: 6px;
            font-weight: 500;
            font-size: 0.9rem;
            cursor: pointer;
            border: none;
            display: inline-flex;
            align-items: center;
            gap: 6px;
            transition: 0.2s;
        }

        .btn-primary {
            background: var(--accent-blue);
            color: white;
        }

        .btn-primary:hover {
            background: var(--accent-dark);
        }

        .btn-danger {
            background: white;
            color: #ef4444;
            border: 1px solid #ef4444;
        }

        .btn-danger:hover {
            background: #fef2f2;
        }

        .btn-ghost {
            background: transparent;
            color: #6b7280;
        }

        .btn-ghost:hover {
            background: #f3f4f6;
            color: #111;
        }

        .btn-sm {
            padding: 5px 10px;
            font-size: 0.8rem;
        }

        .loading-spinner {
            position: fixed;
            bottom: 20px;
            right: 20px;
            background: #111;
            color: white;
            padding: 10px 20px;
            border-radius: 50px;
            font-size: 0.9rem;
            z-index: 9999;
            display: none;
            align-items: center;
            gap: 10px;
            box-shadow: 0 5px 20px rgba(0, 0, 0, 0.2);
        }

        /* Price Form */
        .price-container {
            max-width: 800px;
            margin: 0 auto;
            background: white;
            padding: 40px;
            border-radius: 12px;
            border: 1px solid #e5e7eb;
        }

        .price-row {
            display: grid;
            grid-template-columns: 2fr 1fr;
            gap: 20px;
            align-items: center;
            padding: 16px 0;
            border-bottom: 1px solid #f1f5f9;
        }

        .price-row:last-child {
            border-bottom: none;
        }

        /* MODAL */
        .modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            z-index: 2000;
            display: flex;
            justify-content: center;
            align-items: center;
            opacity: 0;
            pointer-events: none;
            transition: 0.2s;
        }

        .modal.open {
            opacity: 1;
            pointer-events: auto;
        }

        .modal-content {
            background: white;
            width: 90%;
            max-width: 700px;
            max-height: 90vh;
            border-radius: 12px;
            overflow-y: auto;
            padding: 30px;
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.2);
            position: relative;
        }

        .close-modal {
            position: absolute;
            top: 20px;
            right: 20px;
            background: #f3f4f6;
            border: none;
            width: 32px;
            height: 32px;
            border-radius: 50%;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .close-modal:hover {
            background: #e5e7eb;
        }

        .detail-row {
            display: grid;
            grid-template-columns: 140px 1fr;
            gap: 20px;
            padding: 12px 0;
            border-bottom: 1px solid #f3f4f6;
            font-size: 0.9rem;
        }

        .detail-label {
            font-weight: 600;
            color: var(--text-muted);
        }

        .detail-value a {
            color: var(--accent-blue);
            text-decoration: underline;
        }
    </style>
</head>

<body>

    <!-- Loading Indicator -->
    <div id="loading" class="loading-spinner"><i class="fa-solid fa-spinner fa-spin"></i> Saving...</div>

    <!-- Auth Screen -->
    <div id="auth-screen">
        <div class="auth-card">
            <h2 class="brand mb-4"><span>></span>Sien-Official</h2>
            <p class="text-gray mb-4">管理パスワードを入力してください</p>
            <input type="password" id="auth-pass" class="form-input" style="text-align: center;" placeholder="Password">
            <button class="btn btn-primary w-full mt-4" onclick="login()">ダッシュボードにログイン</button>
            <p id="auth-msg" class="text-sm mt-4" style="color:#ef4444;"></p>
        </div>
    </div>

    <!-- Header -->
    <header class="admin-header">
        <div class="brand"><span>></span>Studio</div>
        <div class="user-menu">
            <span class="text-sm font-bold">Sien</span>
            <div class="avatar"><img src="./assets/profile.jpg" alt=""></div>
            <button class="btn btn-ghost btn-sm" onclick="logout()"><i
                    class="fa-solid fa-right-from-bracket"></i></button>
        </div>
    </header>

    <!-- Nav -->
    <nav class="nav-bar">
        <div class="nav-item active" onclick="switchTab('orders')">依頼管理</div>
        <div class="nav-item" onclick="switchTab('portfolio')">ポートフォリオ</div>
        <div class="nav-item" onclick="switchTab('prices')">プラン・料金設定</div>
    </nav>

    <!-- Main Content -->
    <main class="main-content">

        <!-- Tab: Orders -->
        <div id="tab-orders" class="tab-pane">
            <div class="page-title">
                依頼管理 <span class="text-sm text-gray" style="font-weight:400;">(Rank: Pro)</span>
            </div>

            <div class="filter-bar">
                <div class="filter-chip active" onclick="filterOrders('all', this)">全て (<span id="count-all">0</span>)
                </div>
                <div class="filter-chip" onclick="filterOrders('未着手', this)">未着手 (<span id="count-new">0</span>)</div>
                <div class="filter-chip" onclick="filterOrders('支払い待ち', this)">支払い待ち</div>
                <div class="filter-chip" onclick="filterOrders('全て入金済み', this)">入金済み</div>
                <div class="filter-chip" onclick="filterOrders('取引終了', this)">取引終了</div>
                <div class="filter-chip" onclick="filterOrders('キャンセル', this)">キャンセル</div>
                <input type="text" class="search-input" placeholder="依頼者名で絞り込み" onkeyup="searchOrders(this.value)">
                <button class="btn btn-primary btn-sm" onclick="fetchData()"><i
                        class="fa-solid fa-rotate-right"></i></button>
            </div>

            <div class="data-card">
                <table class="data-table">
                    <thead>
                        <tr>
                            <th>ご依頼日</th>
                            <th>曲名</th>
                            <th>ご依頼者名</th>
                            <th>プラン</th>
                            <th>支払い</th>
                            <th>納期</th>
                            <th>ステータス</th>
                        </tr>
                    </thead>
                    <tbody id="order-list">
                        <!-- JS Insert -->
                    </tbody>
                </table>
            </div>
        </div>

        <!-- Tab: Portfolio -->
        <div id="tab-portfolio" class="tab-pane hidden">
            <div class="flex justify-between items-center mb-4">
                <div class="page-title" style="margin:0;">ポートフォリオ</div>
                <button class="btn btn-primary" onclick="savePortfolio()"><i class="fa-solid fa-cloud-arrow-up"></i>
                    変更を保存</button>
            </div>

            <div class="mb-4">
                <div class="filter-bar" style="display:inline-flex;">
                    <div class="filter-chip active" onclick="switchPfCat('works', this)">制作実績 (Works)</div>
                    <div class="filter-chip" onclick="switchPfCat('mix', this)">Mix Samples</div>
                    <div class="filter-chip" onclick="switchPfCat('orig', this)">Original Songs</div>
                </div>
            </div>

            <!-- Pf Works -->
            <div id="pf-works" class="pf-grid"></div>
            <div id="pf-mix" class="pf-grid hidden"></div>
            <div id="pf-orig" class="pf-grid hidden"></div>

            <div class="mt-4 text-center">
                <button class="btn btn-ghost" style="border:1px dashed #ccc; width:100%; padding:20px;"
                    onclick="addPfItem()">+ 新規アイテムを追加</button>
            </div>
        </div>

        <!-- Tab: Prices -->
        <div id="tab-prices" class="tab-pane hidden">
            <div class="page-title">プラン・料金設定</div>
            <div class="price-container">
                <h3 class="font-bold mb-4"
                    style="border-bottom:2px solid var(--accent-blue); padding-bottom:10px; display:inline-block;">基本プラン
                </h3>
                <div id="price-form">
                    <!-- JS Insert -->
                </div>
                <div class="mt-4 text-right">
                    <button class="btn btn-primary" onclick="savePrices()">設定を保存</button>
                </div>
            </div>
        </div>

    </main>


    <!-- Order Detail Modal -->
    <div id="order-detail-modal" class="modal">
        <div class="modal-content">
            <button class="close-modal" onclick="closeModal()"><i class="fa-solid fa-xmark"></i></button>
            <h2 id="modal-title" class="page-title"
                style="margin-bottom:20px; border-bottom:1px solid #eee; padding-bottom:10px;"></h2>
            <div id="modal-body"></div>
        </div>
    </div>

    <!-- JAVASCRIPT LOGIC -->
    <script>
        // --- CORE STATE ---
        let TOKEN = localStorage.getItem('admin_token') || '';
        let DATA = { orders: [], works: [], mix: [], orig: [], prices: {} };
        let activePfCat = 'works';

        // --- AUTH ---
        function checkAuth() {
            if (TOKEN) {
                document.getElementById('auth-screen').style.display = 'none';
                fetchData();
            }
        }
        async function login() {
            const pass = document.getElementById('auth-pass').value;
            if (!pass) return;
            try {
                const res = await fetch('/api/admin', { headers: { 'x-admin-password': pass } });
                if (res.ok) {
                    TOKEN = pass;
                    localStorage.setItem('admin_token', pass);
                    checkAuth();
                } else {
                    document.getElementById('auth-msg').innerText = "パスワードが正しくありません";
                }
            } catch (e) { alert("Network Error"); }
        }
        function logout() { localStorage.removeItem('admin_token'); location.reload(); }

        // --- FETCH ---
        async function fetchData() {
            document.getElementById('loading').style.display = 'flex';
            try {
                const res = await fetch('/api/admin', { headers: { 'x-admin-password': TOKEN } });
                if (res.status === 401) return logout();
                DATA = await res.json();

                renderOrders();
                renderPortfolio();
                renderPrices();

                // Update Counts
                document.getElementById('count-all').innerText = DATA.orders.length;
                document.getElementById('count-new').innerText = DATA.orders.filter(o => o.status === '未着手').length;

            } catch (e) { console.error(e); }
            finally { document.getElementById('loading').style.display = 'none'; }
        }

        // --- TABS ---
        function switchTab(id) {
            document.querySelectorAll('.tab-pane').forEach(el => el.classList.add('hidden'));
            document.querySelectorAll('.nav-item').forEach(el => el.classList.remove('active'));
            document.getElementById(`tab-${id}`).classList.remove('hidden');
            // Assuming order matches: 0=orders, 1=pf, 2=prices
            const idx = id === 'orders' ? 0 : id === 'portfolio' ? 1 : 2;
            document.querySelectorAll('.nav-item')[idx].classList.add('active');
        }

        // --- ORDERS UI ---
        let currentStatusFilter = 'all';
        function filterOrders(status, btn) {
            currentStatusFilter = status;
            if (btn) {
                document.querySelectorAll('#tab-orders .filter-chip').forEach(c => c.classList.remove('active'));
                btn.classList.add('active');
            }
            renderOrders();
        }
        function searchOrders(query) {
            renderOrders(query);
        }

        function renderOrders(query = '') {
            const tbody = document.getElementById('order-list');
            tbody.innerHTML = '';

            const list = [...DATA.orders].reverse().filter(o => {
                const matchesStatus = currentStatusFilter === 'all' || o.status === currentStatusFilter;
                const matchesSearch = !query || JSON.stringify(o).toLowerCase().includes(query.toLowerCase());
                return matchesStatus && matchesSearch;
            });

            list.forEach(o => {
                const date = new Date(o.date).toLocaleDateString('ja-JP');
                const badgeClass = getStatusClass(o.status);

                const tr = document.createElement('tr');
                tr.innerHTML = `
                    <td><div class="text-sm font-bold text-gray">${date}</div></td>
                    <td><div class="font-bold text-primary" style="color:var(--accent-blue); cursor:pointer;" onclick="openOrderDetail('${o.id}')">${o['曲名']}</div></td>
                    <td><div class="user-cell"><span class="user-name">${o['ご依頼者名']}</span><span class="user-sub">${o['TwitterID(任意)']}</span></div></td>
                    <td><span class="text-sm">${o['プラン']}</span></td>
                    <td>
                        ${o.paymentLink ? `<a href="${o.paymentLink}" target="_blank" class="btn btn-ghost btn-sm" style="color:#0ea5e9;">¥ 支払いリンク</a>` : `<button class="btn btn-ghost btn-sm text-gray" onclick="setPayLink('${o.id}')">未設定</button>`}
                    </td>
                    <td><span class="text-sm text-gray">未設定</span></td>
                    <td>
                        <select class="status-badge ${badgeClass}" style="border:none; cursor:pointer;" onchange="updateStatus('${o.id}', this.value)">
                            ${['未着手', '支払い待ち', '全て入金済み', '納品済み', '取引終了', 'キャンセル'].map(s => `<option value="${s}" ${o.status === s ? 'selected' : ''}>${s}</option>`).join('')}
                        </select>
                    </td>
                `;
                tbody.appendChild(tr);
            });
        }
        function getStatusClass(s) {
            if (s === '未着手') return 'bg-gray-100';
            if (s === '支払い待ち') return 'bg-orange-100';
            if (s === '全て入金済み') return 'bg-green-100';
            if (s === '取引終了') return 'bg-gray-100';
            if (s === 'キャンセル') return 'bg-red-100';
            return 'bg-blue-100';
        }
        async function updateStatus(id, val) {
            await postAPI('update_order_status', { orderId: id, updates: { status: val } });
            fetchData();
        }
        async function setPayLink(id) {
            const l = prompt("支払いリンク (Stripe/Square URL) を入力:");
            if (l) {
                await postAPI('update_order_status', { orderId: id, updates: { paymentLink: l } });
                fetchData();
            }
        }

        // --- PORTFOLIO UI ---
        function switchPfCat(cat, btn) {
            activePfCat = cat;
            document.querySelectorAll('#tab-portfolio .filter-chip').forEach(c => c.classList.remove('active'));
            btn.classList.add('active');

            ['works', 'mix', 'orig'].forEach(k => document.getElementById(`pf-${k}`).classList.add('hidden'));
            document.getElementById(`pf-${cat}`).classList.remove('hidden');
        }

        function renderPortfolio() {
            renderPfGrid('works', DATA.works);
            renderPfGrid('mix', DATA.mix);
            renderPfGrid('orig', DATA.orig);
        }

        function renderPfGrid(cat, items) {
            const el = document.getElementById(`pf-${cat}`);
            el.innerHTML = '';
            (items || []).forEach((item, idx) => {
                const div = document.createElement('div');
                div.className = 'pf-card';
                div.innerHTML = `
                    <div class="pf-thumb"><iframe src="https://www.youtube.com/embed/${item.id}"></iframe></div>
                    <div class="pf-body">
                        <label class="form-label">YouTube ID</label>
                        <input class="form-input" value="${item.id}" onchange="updatePfData('${cat}', ${idx}, 'id', this.value)">
                        <label class="form-label">Title / Comment</label>
                        <input class="form-input" value="${item.title || ''}" onchange="updatePfData('${cat}', ${idx}, 'title', this.value)">
                        
                        <div class="action-bar" style="display:flex; justify-content:space-between; align-items:center;">
                            <div class="sort-controls" style="display:flex; gap:4px;">
                                <button class="btn btn-ghost btn-sm" onclick="movePfItem('${cat}', ${idx}, -1)" ${idx === 0 ? 'disabled' : ''}>
                                    <i class="fa-solid fa-arrow-up"></i>
                                </button>
                                <button class="btn btn-ghost btn-sm" onclick="movePfItem('${cat}', ${idx}, 1)" ${idx === items.length - 1 ? 'disabled' : ''}>
                                    <i class="fa-solid fa-arrow-down"></i>
                                </button>
                            </div>
                            <button class="btn btn-danger btn-sm" onclick="delPf('${cat}', ${idx})"><i class="fa-regular fa-trash-can"></i> 削除</button>
                        </div>
                    </div>
                `;
                el.appendChild(div);
            });
        }

        function movePfItem(cat, idx, dir) {
            const list = DATA[cat];
            const newIdx = idx + dir;
            if (newIdx < 0 || newIdx >= list.length) return;
            // Swap
            [list[idx], list[newIdx]] = [list[newIdx], list[idx]];
            renderPortfolio();
        }
        // Helper to extract YouTube ID
        function extractYouTubeId(url) {
            if (!url) return '';
            url = url.trim();
            // If already an ID (11 chars alphanumeric/dash/underscore), return as is
            if (/^[a-zA-Z0-9_-]{11}$/.test(url)) return url;

            // Regex to find ID in URL
            const regExp = /^.*(youtu.be\/|v\/|u\/\w\/|embed\/|watch\?v=|\&v=)([^#\&\?]*).*/;
            const match = url.match(regExp);
            return (match && match[2].length === 11) ? match[2] : url;
        }

        function updatePfData(cat, idx, key, val) {
            if (key === 'id') {
                const cleanId = extractYouTubeId(val);
                DATA[cat][idx][key] = cleanId;
                // Force update UI (to show thumbnail and clean ID)
                renderPortfolio();
            } else {
                DATA[cat][idx][key] = val;
            }
        }
        function addPfItem() {
            if (!DATA[activePfCat]) DATA[activePfCat] = [];
            DATA[activePfCat].push({ id: '', title: '' });
            renderPortfolio();
        }
        function delPf(cat, idx) {
            if (confirm("削除しますか？")) { DATA[cat].splice(idx, 1); renderPortfolio(); }
        }
        async function savePortfolio() {
            document.getElementById('loading').style.display = 'flex';
            await postAPI('update_portfolio', { category: 'works', items: DATA.works });
            await postAPI('update_portfolio', { category: 'mix', items: DATA.mix });
            await postAPI('update_portfolio', { category: 'orig', items: DATA.orig });
            document.getElementById('loading').style.display = 'none';
            alert("保存しました");
        }

        // Helper: Price Formatter
        function formatPriceInput(input) {
            let val = input.value.replace(/[^0-9]/g, ''); // Remove non-numbers
            if (!val) return;
            // Format: 10,000円
            input.value = Number(val).toLocaleString() + '円';
            DATA.prices[input.dataset.key] = input.value;
        }

        // --- PRICES UI ---
        function renderPrices() {
            const el = document.getElementById('price-form');
            el.innerHTML = '';

            // Mix Plans
            el.innerHTML += `<h4 class="font-bold mt-4 mb-2" style="color:var(--accent-blue);">ミックス・マスタリング</h4>`;
            const mixLabels = {
                'mix_std': 'スタンダードプラン',
                'mix_one': 'ワンコーラスプラン',
                'mix_short': 'ショート動画用MIX',
                'mix_speed': 'スピードプラン',
                'mix_super': '超スピードプラン',
                'mix_collab': 'コラボ・合唱プラン'
            };
            Object.entries(mixLabels).forEach(([k, label]) => {
                const val = DATA.prices[k] || '';
                el.innerHTML += `
                    <div class="price-row">
                        <label>${label}</label>
                        <input class="form-input" 
                               value="${val}" 
                               data-key="${k}"
                               onblur="formatPriceInput(this)"
                               onfocus="this.value = this.value.replace(/[^0-9]/g, '')" 
                               onchange="DATA.prices['${k}'] = this.value">
                    </div>
                `;
            });

            // Original Plans
            el.innerHTML += `<h4 class="font-bold mt-4 mb-2" style="color:var(--accent-blue);">オリジナル楽曲制作</h4>`;
            const origLabels = {
                'orig_std': 'スタンダードプラン',
                'orig_lyrics': '作詞持ち込みプラン',
                'opt_live': 'オプション：生楽器演奏追加'
            };
            Object.entries(origLabels).forEach(([k, label]) => {
                const val = DATA.prices[k] || '';
                el.innerHTML += `
                    <div class="price-row">
                        <label>${label}</label>
                        <input class="form-input" 
                               value="${val}" 
                               data-key="${k}"
                               onblur="formatPriceInput(this)"
                               onfocus="this.value = this.value.replace(/[^0-9]/g, '')"
                               onchange="DATA.prices['${k}'] = this.value">
                    </div>
                `;
            });
        }
        async function savePrices() {
            document.getElementById('loading').style.display = 'flex';
            await postAPI('update_prices', DATA.prices);
            document.getElementById('loading').style.display = 'none';
            alert("料金を保存しました");
        }

        // --- API UTILS ---
        async function postAPI(action, data) {
            await fetch('/api/admin', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json', 'x-admin-password': TOKEN },
                body: JSON.stringify({ action, data })
            });
        }

        // Init
        checkAuth();

        // --- MODAL UTILS ---
        function openOrderDetail(id) {
            const order = DATA.orders.find(o => o.id === id);
            if (!order) return;

            document.getElementById('modal-title').innerText = order['曲名'] || '詳細';

            const fields = [
                { label: 'ID', val: order.id },
                { label: 'ご依頼者名', val: order['ご依頼者名'] },
                { label: 'メールアドレス', val: order['メールアドレス'] },
                { label: 'Twitter ID', val: order['TwitterID(任意)'] },
                { label: '希望連絡手段', val: order['希望する連絡手段'] },
                { label: 'プラン', val: order['プラン'] },
                { label: '曲名', val: order['曲名'] },
                { label: 'Mix & Mastering', val: 'Mix & Mastering' }, // Fixed value per request
                { label: 'レコーディング音源', val: order['レコーディング済み音源'], type: 'link' },
                { label: 'キー変更', val: order['キー変更'] },
                { label: '参考URL', val: order['参考URL(任意)'], type: 'link' },
                { label: 'ご要望・備考', val: order['ご要望・ご質問・特記事項など'] || 'なし', type: 'text' },
                { label: 'ステータス', val: `<span class="status-badge ${getStatusClass(order.status)}">${order.status}</span>`, type: 'html' }
            ];

            const html = fields.map(f => {
                let displayVal = f.val;
                if (f.type === 'link' && f.val) {
                    displayVal = `<a href="${f.val}" target="_blank">${f.val}</a>`;
                } else if (f.type === 'text') {
                    displayVal = `<div style="white-space: pre-wrap;">${f.val}</div>`;
                }
                if (!displayVal || displayVal === 'なし') displayVal = '<span style="color:#ccc;">(未入力)</span>';

                return `
                    <div class="detail-row">
                        <div class="detail-label">${f.label}</div>
                        <div class="detail-value">${f.type === 'html' ? f.val : displayVal}</div>
                    </div>
                `;
            }).join('');

            document.getElementById('modal-body').innerHTML = html;
            document.getElementById('order-detail-modal').classList.add('open');
        }

        function closeModal() {
            document.getElementById('order-detail-modal').classList.remove('open');
        }

    </script>
</body>

</html>