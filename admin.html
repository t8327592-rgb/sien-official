<!DOCTYPE html>
<html lang="ja">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Dashboard | Sien-Official</title>
    <!-- Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link
        href="https://fonts.googleapis.com/css2?family=Jost:wght@400;500;600&family=Noto+Sans+JP:wght@400;500;700&display=swap"
        rel="stylesheet">
    <!-- Icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

    <!-- Favicon -->
    <link rel="icon" href="./assets/favicon.ico">

    <style>
        :root {
            /* Copied from style.css */
            --primary: #3b82f6;
            /* Matching Public Site Accent */
            --bg-color: #f3f4f6;
            /* --bg-gray */
            --text-main: #111827;
            --text-muted: #6b7280;
            --text-light: #9ca3af;
            --border-color: #e5e7eb;
            --white: #ffffff;
            --shadow-sm: 0 1px 2px 0 rgba(0, 0, 0, 0.05);
            --shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);

            --font-heading: 'Jost', sans-serif;
            --font-body: 'Noto Sans JP', sans-serif;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            background-color: var(--bg-color);
            color: var(--text-main);
            font-family: var(--font-body);
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            -webkit-font-smoothing: antialiased;
        }

        h1,
        h2,
        h3,
        h4,
        h5 {
            font-family: var(--font-heading);
            font-weight: 500;
        }

        /* HEADER */
        .admin-header {
            background: rgba(255, 255, 255, 0.9);
            backdrop-filter: blur(10px);
            height: 70px;
            /* Matching public header height */
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 0 40px;
            border-bottom: 1px solid var(--border-color);
            position: sticky;
            top: 0;
            z-index: 50;
        }

        .brand {
            font-weight: 700;
            font-size: 1.4rem;
            letter-spacing: 0.02em;
            display: flex;
            align-items: center;
            gap: 10px;
            color: var(--text-main);
            text-decoration: none;
            font-family: var(--font-heading);
        }

        .brand img {
            height: 28px;
        }

        .user-menu {
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .user-avatar {
            width: 32px;
            height: 32px;
            background: #ddd;
            border-radius: 50%;
            overflow: hidden;
            border: 1px solid var(--border-color);
        }

        .user-avatar img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        /* SUB NAV */
        .sub-nav {
            background: var(--white);
            border-bottom: 1px solid var(--border-color);
            padding: 0 40px;
            display: flex;
            gap: 30px;
        }

        .nav-tab {
            padding: 16px 5px;
            font-size: 0.95rem;
            color: var(--text-muted);
            cursor: pointer;
            position: relative;
            transition: color 0.2s;
            font-family: var(--font-heading);
        }

        .nav-tab:hover {
            color: var(--primary);
        }

        .nav-tab.active {
            color: var(--primary);
            font-weight: 600;
        }

        .nav-tab.active::after {
            content: '';
            position: absolute;
            bottom: -1px;
            left: 0;
            width: 100%;
            height: 2px;
            background: var(--primary);
        }

        /* MAIN */
        .main-container {
            flex: 1;
            padding: 40px;
            max-width: 1200px;
            /* Matching public container width approx */
            margin: 0 auto;
            width: 100%;
        }

        .breadcrumb {
            font-size: 0.85rem;
            color: var(--primary);
            margin-bottom: 20px;
            font-weight: 500;
        }

        .breadcrumb span {
            color: var(--text-muted);
        }

        .page-header {
            display: flex;
            align-items: center;
            gap: 15px;
            margin-bottom: 30px;
        }

        .page-title {
            font-size: 1.5rem;
            font-weight: 600;
            letter-spacing: -0.02em;
        }

        .badge-rank {
            font-size: 0.75rem;
            background: #eff6ff;
            color: var(--primary);
            padding: 4px 10px;
            border-radius: 99px;
            font-weight: 600;
            letter-spacing: 0.05em;
            border: 1px solid #dbeafe;
        }

        .content-card {
            background: var(--white);
            border-radius: 12px;
            /* Softer radius */
            padding: 30px;
            box-shadow: var(--shadow);
            min-height: 600px;
            border: 1px solid var(--border-color);
        }

        .tab-pane {
            display: none;
        }

        .tab-pane.active {
            display: block;
            animation: fadeIn 0.3s ease;
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(5px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        /* FILTER */
        .filter-section {
            display: flex;
            flex-direction: column;
            gap: 20px;
            margin-bottom: 30px;
            border-bottom: 1px solid var(--border-color);
            padding-bottom: 20px;
        }

        .search-row {
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .search-input-group {
            display: flex;
            border: 1px solid var(--border-color);
            border-radius: 8px;
            overflow: hidden;
            width: 320px;
            transition: 0.2s;
        }

        .search-input-group:focus-within {
            border-color: var(--primary);
            ring: 2px solid var(--primary);
        }

        .search-prefix {
            background: var(--primary);
            color: white;
            padding: 10px 14px;
            font-size: 0.9rem;
            font-weight: 600;
            white-space: nowrap;
        }

        .search-input {
            border: none;
            padding: 10px 14px;
            outline: none;
            width: 100%;
            font-size: 0.9rem;
            color: var(--text-main);
        }

        .status-tabs {
            display: flex;
            gap: 24px;
            font-size: 0.9rem;
            color: var(--text-muted);
            margin-top: 10px;
            overflow-x: auto;
            padding-bottom: 5px;
        }

        .status-tab {
            cursor: pointer;
            position: relative;
            padding-bottom: 8px;
            white-space: nowrap;
        }

        .status-tab:hover {
            color: var(--primary);
        }

        .status-tab.active {
            color: var(--primary);
            font-weight: 600;
            border-bottom: 2px solid var(--primary);
        }

        .count-badge {
            margin-left: 6px;
            font-size: 0.8em;
            color: var(--text-light);
            background: #f3f4f6;
            padding: 2px 6px;
            border-radius: 4px;
        }

        /* TABLE */
        .admin-table {
            width: 100%;
            border-collapse: separate;
            border-spacing: 0;
            font-size: 0.9rem;
        }

        .admin-table th {
            text-align: left;
            padding: 16px 12px;
            font-weight: 600;
            color: var(--text-muted);
            border-bottom: 1px solid var(--border-color);
            white-space: nowrap;
            font-family: var(--font-heading);
            letter-spacing: 0.03em;
        }

        .admin-table td {
            padding: 20px 12px;
            border-bottom: 1px solid #f9fafb;
            vertical-align: middle;
        }

        .admin-table tr:hover td {
            background: #f9fafb;
        }

        .client-name {
            font-weight: 600;
            color: var(--text-main);
        }

        .plan-name {
            font-size: 0.85rem;
            color: var(--text-muted);
        }

        .pay-link {
            color: var(--primary);
            text-decoration: none;
            font-weight: 500;
            font-size: 0.85rem;
            display: inline-flex;
            align-items: center;
            gap: 5px;
        }

        .pay-link:hover {
            text-decoration: underline;
        }

        .status-btn {
            background: #9ca3af;
            color: white;
            border: none;
            padding: 6px 14px;
            border-radius: 6px;
            font-size: 0.8rem;
            cursor: pointer;
            transition: all 0.2s;
            font-weight: 500;
        }

        .status-btn:hover {
            opacity: 0.9;
            transform: translateY(-1px);
        }

        .status-btn.done {
            background: #d1d5db;
            color: #6b7280;
        }

        .status-btn.active {
            background: var(--primary);
            box-shadow: 0 2px 4px rgba(59, 130, 246, 0.3);
        }

        .status-badge {
            border: 1px solid var(--border-color);
            padding: 6px 10px;
            border-radius: 6px;
            font-size: 0.85rem;
            color: var(--text-main);
            cursor: pointer;
        }

        /* PF GRID */
        .pf-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
            gap: 25px;
        }

        .pf-item {
            border: 1px solid var(--border-color);
            border-radius: 12px;
            overflow: hidden;
            background: #fff;
            transition: 0.2s;
        }

        .pf-item:hover {
            box-shadow: var(--shadow);
            transform: translateY(-2px);
        }

        .pf-thumb {
            height: 180px;
            background: #000;
            position: relative;
        }

        .pf-thumb iframe {
            width: 100%;
            height: 100%;
            border: none;
        }

        .pf-inputs {
            padding: 16px;
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        .pf-input {
            width: 100%;
            padding: 10px;
            border: 1px solid var(--border-color);
            border-radius: 6px;
            font-size: 0.9rem;
            transition: 0.2s;
        }

        .pf-input:focus {
            border-color: var(--primary);
            outline: none;
        }

        /* PRICES */
        .price-stack {
            display: flex;
            flex-direction: column;
            gap: 30px;
            max-width: 800px;
            margin: 0 auto;
        }

        .price-group {
            border-bottom: 1px solid var(--border-color);
            padding-bottom: 30px;
        }

        .price-row {
            display: flex;
            gap: 15px;
            margin-bottom: 15px;
        }

        .price-input-lg {
            font-size: 1.1rem;
            font-weight: 600;
            padding: 10px;
            width: 100%;
        }

        /* FOOTER */
        .admin-footer {
            background: var(--bg-dark);
            color: #d1d5db;
            padding: 20px 0;
            font-size: 0.9rem;
            text-align: center;
        }

        .footer-cols {
            display: none;
        }

        .footer-col h4 {
            color: white;
            margin-bottom: 20px;
            font-size: 1rem;
            font-family: var(--font-heading);
            letter-spacing: 0.05em;
        }

        .footer-col ul {
            list-style: none;
        }

        .footer-col li {
            margin-bottom: 10px;
        }

        .footer-col a {
            color: #9ca3af;
            text-decoration: none;
            transition: 0.2s;
        }

        .footer-col a:hover {
            color: var(--primary);
        }

        button:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        /* Buttons Public Style */
        .btn {
            padding: 10px 20px;
            border-radius: 8px;
            /* Slightly rounded like public */
            border: none;
            cursor: pointer;
            font-size: 0.95rem;
            font-weight: 500;
            transition: all 0.3s;
            font-family: var(--font-heading);
            display: inline-flex;
            align-items: center;
            gap: 8px;
            justify-content: center;
        }

        .btn-primary {
            background: var(--primary);
            /* Gradient? Public uses accents */
            background: linear-gradient(135deg, #3b82f6, #2563eb);
            color: white;
            box-shadow: 0 4px 6px rgba(59, 130, 246, 0.2);
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 12px rgba(59, 130, 246, 0.3);
        }

        .btn-sm {
            padding: 6px 12px;
            font-size: 0.85rem;
        }
    </style>
</head>

<body>
    <!-- AUTH -->
    <div id="auth-screen"
        style="position:fixed; top:0; left:0; width:100%; height:100%; background:#f3f4f6; z-index:9999; display:flex; align-items:center; justify-content:center;">
        <div
            style="background:white; padding:40px; border-radius:8px; width:350px; text-align:center; box-shadow:0 10px 25px rgba(0,0,0,0.05);">
            <h2 style="font-weight:700; margin-bottom:20px;">Sien-Official</h2>
            <input type="password" id="auth-pass" placeholder="Password"
                style="width:100%; padding:10px; margin-bottom:15px; border:1px solid #ddd; border-radius:4px;">
            <button onclick="login()" class="btn btn-primary" style="width:100%;">Login</button>
        </div>
    </div>

    <header class="admin-header">
        <a href="#" class="brand">
            <img src="./assets/logo.png" alt="Logo">
        </a>
        <div class="user-menu">
            <button onclick="logout()" class="btn btn-sm" style="background:#eee;">Logout</button>
        </div>
    </header>

    <nav class="sub-nav">
        <div class="nav-tab active" onclick="switchTab('orders', this)">依頼管理</div>
        <div class="nav-tab" onclick="switchTab('portfolio', this)">ポートフォリオ</div>
        <div class="nav-tab" onclick="switchTab('prices', this)">プラン・料金設定</div>
        <div class="nav-tab" onclick="switchTab('account', this)">アカウント設定</div>
    </nav>

    <main class="main-container">
        <div class="breadcrumb">
            マイページTOP > <span id="page-crumb">依頼管理</span>
        </div>

        <section class="content-card">
            <!-- ORDERS TAB -->
            <div id="tab-orders" class="tab-pane active">
                <div class="page-header">
                    <div class="page-title">依頼管理</div>
                </div>

                <div class="filter-section">
                    <div class="search-row">
                        <div class="search-input-group">
                            <div class="search-prefix"><i class="fa-solid fa-folder"></i> = まとめて依頼</div>
                            <input type="text" class="search-input" placeholder="依頼者名で絞り込み"
                                onkeyup="renderOrders(this.value)">
                        </div>
                    </div>
                    <div class="status-tabs">
                        <div class="status-tab active" onclick="setFilter('all', this)">全て(<span id="cnt-all">0</span>)
                        </div>
                        <div class="status-tab" onclick="setFilter('未着手', this)">未着手(<span id="cnt-new">0</span>)</div>
                        <div class="status-tab" onclick="setFilter('支払い待ち', this)">支払い待ち(<span id="cnt-pay">0</span>)
                        </div>
                        <div class="status-tab" onclick="setFilter('全て入金済み', this)">入金済み(<span id="cnt-paid">0</span>)
                        </div>
                        <div class="status-tab" onclick="setFilter('納品済み', this)">納品済み(<span id="cnt-done">0</span>)
                        </div>
                        <div class="status-tab" onclick="setFilter('取引終了', this)">取引終了(<span id="cnt-closed">0</span>)
                        </div>
                        <div class="status-tab" onclick="setFilter('archive', this)">キャンセル(<span
                                id="cnt-cancel">0</span>)</div>
                    </div>
                </div>

                <table class="admin-table">
                    <thead>
                        <tr>
                            <th>ご依頼日</th>
                            <th>曲名</th>
                            <th>ご依頼者名</th>
                            <th>プラン</th>
                            <th>納期 <i class="fa-solid fa-gear" style="color:var(--primary);"></i></th>
                            <th>納品完了/キャンセル</th>
                            <th>ステータス</th>
                        </tr>
                    </thead>
                    <tbody id="order-tbody"></tbody>
                </table>
            </div>

            <!-- PORTFOLIO TAB -->
            <div id="tab-portfolio" class="tab-pane">
                <div class="page-header" style="justify-content:space-between;">
                    <div class="page-title">ポートフォリオ設定</div>
                    <button class="btn btn-primary" onclick="savePf()">保存する</button>
                </div>
                <div class="mb-4">
                    <button class="btn" style="background:#eee;" onclick="addPf()">+ 追加</button>
                    <select id="pf-cat-select" onchange="renderPf()" style="padding:5px; margin-left:10px;">
                        <option value="works">制作実績 (Works)</option>
                        <option value="mix">ミックス (Mix)</option>
                        <option value="orig">オリジナル (Original)</option>
                    </select>
                </div>
                <div id="pf-container" class="pf-grid"></div>
            </div>

            <!-- PRICES TAB -->
            <div id="tab-prices" class="tab-pane">
                <div class="page-header" style="justify-content:space-between;">
                    <div class="page-title">プラン・料金設定</div>
                    <button class="btn btn-primary" onclick="savePrices()">保存する</button>
                </div>
                <div id="price-container" class="price-stack"></div>
                <div style="text-align:center; margin-top:30px;">
                    <button class="btn" style="background:#eee;" onclick="addPlan()">+ プランを追加</button>
                </div>
            </div>

            <div id="tab-account" class="tab-pane">
                <div class="page-title">アカウント設定</div>
                <p>Not implemented yet.</p>
            </div>
        </section>
    </main>

    <footer class="admin-footer">
        <div style="text-align:center;">
            Copyright (c) 2026 Sien-Official. All Rights Reserved.
        </div>
    </footer>

    <script>
        let TOKEN = localStorage.getItem('admin_token') || '';
        let DATA = { orders: [], works: [], mix: [], orig: [], prices: { mix: [], orig: [] } };
        let activePfCat = 'works';

        function checkAuth() {
            if (TOKEN) {
                document.getElementById('auth-screen').style.display = 'none';
                fetchData();
            }
        }
        async function login() {
            const pass = document.getElementById('auth-pass').value;
            try {
                const res = await fetch('/api/admin', { headers: { 'x-admin-password': pass } });
                if (res.ok) {
                    TOKEN = pass;
                    localStorage.setItem('admin_token', pass);
                    checkAuth();
                } else alert("Invalid Password");
            } catch (e) { alert("Error"); }
        }
        function logout() { localStorage.removeItem('admin_token'); location.reload(); }

        async function fetchData() {
            try {
                const res = await fetch('/api/admin', { headers: { 'x-admin-password': TOKEN } });
                if (res.status === 401) { logout(); return; }
                const json = await res.json();
                DATA = { ...DATA, ...json };

                if (Array.isArray(DATA.prices)) DATA.prices = { mix: [], orig: [] };
                if (!DATA.prices.mix) DATA.prices.mix = [];
                if (!DATA.prices.orig) DATA.prices.orig = [];
                if (!DATA.archive) DATA.archive = [];

                renderOrders();
                renderPf();
                renderPrices();
            } catch (e) { console.error(e); }
        }

        async function postAPI(action, data) {
            await fetch('/api/admin', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json', 'x-admin-password': TOKEN },
                body: JSON.stringify({ action, data })
            });
        }

        function switchTab(tabId, el) {
            document.querySelectorAll('.tab-pane').forEach(d => d.classList.remove('active'));
            document.getElementById('tab-' + tabId).classList.add('active');

            document.querySelectorAll('.nav-tab').forEach(t => t.classList.remove('active'));
            el.classList.add('active');

            const map = { 'orders': '依頼管理', 'portfolio': 'ポートフォリオ', 'prices': 'プラン設定', 'account': 'アカウント' };
            document.getElementById('page-crumb').innerText = map[tabId];
        }

        // --- ORDERS LOGIC ---
        let filterStatus = 'all';

        function setFilter(stat, el) {
            filterStatus = stat;
            document.querySelectorAll('.status-tab').forEach(t => t.classList.remove('active'));
            el.classList.add('active');
            renderOrders();
        }

        function renderOrders(query = '') {
            const tbody = document.getElementById('order-tbody');
            tbody.innerHTML = '';

            let list = [];
            let isArchive = (filterStatus === 'archive' || filterStatus === 'cancel');

            if (isArchive) {
                const archived = DATA.archive || [];
                const cancelled = (DATA.orders || []).filter(o => o.status === 'キャンセル');
                list = [...archived, ...cancelled];
            } else {
                list = DATA.orders || [];
                if (filterStatus !== 'all') {
                    list = list.filter(o => o.status === filterStatus);
                } else {
                    list = list.filter(o => o.status !== 'キャンセル' && o.status !== 'archived');
                }
            }

            if (query) {
                list = list.filter(o => (o['ご依頼者名'] || '').includes(query) || (o['曲名'] || '').includes(query));
            }

            list.sort((a, b) => new Date(b.date) - new Date(a.date));

            // Update Counts
            const counts = { 'archive': (DATA.archive || []).length };
            (DATA.orders || []).forEach(o => counts[o.status] = (counts[o.status] || 0) + 1);

            ['未着手', '支払い待ち', '全て入金済み', '納品済み', '取引終了'].forEach(k => {
                const el = document.getElementById('cnt-' + (k === '全て入金済み' ? 'paid' : k === '未着手' ? 'new' : k === '支払い待ち' ? 'pay' : k === '納品済み' ? 'done' : 'closed'));
                if (el) el.innerText = counts[k] || 0;
            });
            document.getElementById('cnt-all').innerText = (DATA.orders || []).length;
            document.getElementById('cnt-cancel').innerText = (counts['キャンセル'] || 0) + (counts['archive'] || 0);

            list.forEach(order => {
                const realIndex = (DATA.orders || []).findIndex(o => o.id === order.id);
                const archiveIndex = (DATA.archive || []).findIndex(a => a.id === order.id);
                const isItemArchived = Boolean(DATA.archive && DATA.archive.find(a => a.id === order.id));

                const tr = document.createElement('tr');
                tr.innerHTML = `
                    <td>${new Date(order.date).toLocaleDateString('ja-JP')}</td>
                    <td class="client-name" onclick="showDetail('${order.id}')">${order['曲名']}</td>
                    <td>${order['ご依頼者名']}</td>
                    <td class="plan-name">${order['プラン']}</td>
                    <td>
                        <input type="date" value="${order.deadline || ''}" 
                            style="border:none; background:transparent; font-family:inherit; cursor:pointer; color:#666;"
                            onchange="updateDeadline('${order.id}', this.value)">
                    </td>
                     <td>
                        ${isItemArchived ?
                        `<button class="status-btn active" onclick="restoreOrder(${archiveIndex}, '${order.id}')">復元</button>` :
                        `<button class="status-btn" onclick="archiveOrder(${realIndex}, '${order.id}')">終了/キャンセル</button>`
                    }
                    </td>
                    <td>
                         ${isItemArchived ? '<span class="count-badge">アーカイブ</span>' :
                        `<select onchange="updateStatus('${order.id}', this.value)" class="status-badge" style="background:#fff;">
                              ${['未着手', '支払い待ち', '全て入金済み', '納品済み', '取引終了', 'キャンセル'].map(s =>
                            `<option value="${s}" ${order.status === s ? 'selected' : ''}>${s}</option>`
                        ).join('')}
                           </select>`
                    }
                    </td>
                `;
                tbody.appendChild(tr);
            });
        }

        function showDetail(id) {
            const order = [...(DATA.orders || []), ...(DATA.archive || [])].find(o => o.id === id);
            if (!order) return;

            document.getElementById('tab-orders').classList.remove('active');
            document.getElementById('tab-order-detail').classList.add('active');

            const content = document.getElementById('detail-content');
            content.innerHTML = `
                <div style="background:#f9fafb; padding:20px; border-radius:8px; margin-bottom:20px;">
                    <div style="display:flex; justify-content:space-between; margin-bottom:10px;">
                        <h3 style="font-size:1.2rem;">${order['曲名']}</h3>
                        <span class="status-badge" style="background:white;">${order.status}</span>
                    </div>
                    <div style="display:grid; grid-template-columns: 1fr 1fr; gap:15px; font-size:0.9rem;">
                        <div><strong>ご依頼者:</strong> ${order['ご依頼者名']}</div>
                        <div><strong>Email:</strong> ${order['email'] || '-'}</div>
                        <div><strong>プラン:</strong> ${order['プラン']}</div>
                        <div><strong>ご依頼日:</strong> ${new Date(order.date).toLocaleDateString('ja-JP')}</div>
                        <div><strong>納期:</strong> ${order.deadline || '未設定'}</div>
                        <div><strong>支払いリンク:</strong> <input value="${order.paymentLink || ''}" placeholder="Payment Link" 
                            onchange="promptPayLink('${order.id}', this.value)" style="padding:4px; border:1px solid #ddd; border-radius:4px; width:200px;"></div>
                    </div>
                </div>

                <div style="background:white; border:1px solid #eee; padding:20px; border-radius:8px;">
                     <h4 style="margin-bottom:15px; border-bottom:1px solid #eee; padding-bottom:10px;">メッセージ / 詳細</h4>
                     <p style="white-space:pre-wrap; color:#444;">${order['要望・相談'] || 'メッセージなし'}</p>
                     
                     <div style="margin-top:20px;">
                        <strong>参考ファイル/URL:</strong>
                        <div style="margin-top:5px; padding:10px; background:#f0f9ff; color:#0369a1; border-radius:4px;">
                            ${order['参考音源'] || 'なし'}
                        </div>
                     </div>
                </div>
            `;
        }

        function closeDetail() {
            document.getElementById('tab-order-detail').classList.remove('active');
            document.getElementById('tab-orders').classList.add('active');
        }

        // Updated promptPayLink to accept direct value if provided, or prompt
        async function promptPayLink(id, val = null) {
            let link = val;
            if (link === null) {
                const order = [...(DATA.orders || []), ...(DATA.archive || [])].find(o => o.id === id);
                if (!order) return;
                link = prompt("支払いリンクを入力:", order.paymentLink || "");
            }
            if (link !== null) {
                await postAPI('update_order_status', { orderId: id, updates: { paymentLink: link } });
                const order = [...(DATA.orders || []), ...(DATA.archive || [])].find(o => o.id === id);
                if (order) order.paymentLink = link;
                if (document.getElementById('tab-orders').classList.contains('active')) renderOrders();
            }
        }

        async function updateStatus(id, status) {
            await postAPI('update_order_status', { orderId: id, status: status });
            const order = DATA.orders.find(o => o.id === id);
            if (order) order.status = status;
            renderOrders();
        }

        async function updateDeadline(id, date) {
            await postAPI('update_order_status', { orderId: id, deadline: date });
            const order = DATA.orders.find(o => o.id === id);
            if (order) order.deadline = date;
        }

        async function archiveOrder(idx, id) {
            if (!confirm("この依頼を終了/キャンセル（アーカイブ）しますか？")) return;
            if (idx === -1) idx = DATA.orders.findIndex(o => o.id === id);
            if (idx === -1) return;

            const item = DATA.orders.splice(idx, 1)[0];
            item.status = 'archived';
            DATA.archive.unshift(item);
            renderOrders();

            await postAPI('archive_order', { index: idx });
        }

        async function restoreOrder(idx, id) {
            if (!confirm("この依頼を復元しますか？")) return;
            if (idx === -1) idx = DATA.archive.findIndex(o => o.id === id);
            if (idx === -1) return;

            const item = DATA.archive.splice(idx, 1)[0];
            item.status = '未着手';
            DATA.orders.unshift(item);
            renderOrders();

            await postAPI('restore_order', { index: idx });
        }

        // --- PORTFOLIO ---
        function renderPf() {
            activePfCat = document.getElementById('pf-cat-select').value;
            const list = DATA[activePfCat] || [];
            const container = document.getElementById('pf-container');
            container.innerHTML = '';

            list.forEach((item, idx) => {
                const div = document.createElement('div');
                div.className = 'pf-item';
                div.innerHTML = `
                    <div class="pf-thumb">
                        ${item.id ? `<iframe src="https://www.youtube.com/embed/${item.id}" loading="lazy"></iframe>` : ''}
                    </div>
                    <div class="pf-inputs">
                        <input class="pf-input" placeholder="YouTube ID" value="${item.id || ''}" onchange="updatePf(${idx}, 'id', this.value)">
                        <input class="pf-input" placeholder="Title" value="${item.title || ''}" onchange="updatePf(${idx}, 'title', this.value)">
                         <button class="btn btn-sm" style="background:#fee; color:red;" onclick="delPf(${idx})">削除</button>
                    </div>
                `;
                container.appendChild(div);
            });
        }
        function updatePf(idx, k, v) {
            if (k === 'id') {
                const reg = /^.*(youtu.be\/|v\/|u\/\w\/|embed\/|watch\?v=|\&v=)([^#\&\?]*).*/;
                const m = v.match(reg);
                if (m && m[2].length === 11) v = m[2];
            }
            DATA[activePfCat][idx][k] = v;
            if (k === 'id') renderPf();
        }
        function addPf() { if (!DATA[activePfCat]) DATA[activePfCat] = []; DATA[activePfCat].push({ id: '' }); renderPf(); }
        function delPf(idx) { DATA[activePfCat].splice(idx, 1); renderPf(); }
        async function savePf() {
            await postAPI('update_portfolio', { category: activePfCat, items: DATA[activePfCat] });
            alert("Saved Portfolio");
        }

        // --- PRICES ---
        function renderPrices() {
            const container = document.getElementById('price-container');
            container.innerHTML = '';

            ['mix', 'orig'].forEach(cat => {
                const header = document.createElement('h3');
                header.innerText = cat === 'mix' ? 'ミックスプラン' : 'オリジナル制作プラン';
                header.style.marginTop = '30px';
                container.appendChild(header);

                const list = DATA.prices[cat] || [];
                list.forEach((plan, idx) => {
                    const div = document.createElement('div');
                    div.className = 'price-group';
                    div.innerHTML = `
                        <div class="price-row" style="justify-content:space-between;">
                            <strong>Plan #${idx + 1}</strong>
                            <button class="btn btn-sm" style="color:red;" onclick="delPrice('${cat}',${idx})">削除</button>
                        </div>
                        <input class="pf-input price-input-lg" value="${plan.title || ''}" placeholder="プラン名" onchange="updPrice('${cat}',${idx},'title',this.value)">
                        <textarea class="pf-input" rows="3" placeholder="説明" onchange="updPrice('${cat}',${idx},'desc',this.value)">${plan.desc || ''}</textarea>
                        <div class="price-row">
                            <input class="pf-input" placeholder="価格" value="${plan.price || ''}" onchange="updPrice('${cat}',${idx},'price',this.value)">
                            <input class="pf-input" placeholder="納期" value="${plan.period || ''}" onchange="updPrice('${cat}',${idx},'period',this.value)">
                            <input class="pf-input" placeholder="修正回数" value="${plan.revisions || ''}" onchange="updPrice('${cat}',${idx},'revisions',this.value)">
                        </div>
                     `;
                    container.appendChild(div);
                });
                const addBtn = document.createElement('button');
                addBtn.className = 'btn';
                addBtn.innerText = '+ ' + cat + ' プラン追加';
                addBtn.style.marginTop = "10px";
                addBtn.onclick = () => { DATA.prices[cat].push({ title: 'New Plan' }); renderPrices(); };
                container.appendChild(addBtn);
            });
        }
        function updPrice(cat, idx, k, v) { DATA.prices[cat][idx][k] = v; }
        function delPrice(cat, idx) { DATA.prices[cat].splice(idx, 1); renderPrices(); }
        async function savePrices() {
            await postAPI('update_prices', DATA.prices);
            alert("Saved Prices");
        }

        checkAuth();
    </script>
</body>

</html>